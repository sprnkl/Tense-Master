<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Grammar Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { primary: '#2563eb', secondary: '#475569' }
        }
      }
    }
  </script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">
  <header class="bg-white shadow-sm z-20 flex-none">
    <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-primary text-3xl">school</span>
        <div>
          <h1 class="text-xl font-bold text-primary tracking-tight">Grammar Master</h1>
          <p class="text-xs text-slate-500">Tenses & Grammar Trainer (100 Verben)</p>
        </div>
      </div>
      <div class="flex items-center gap-3 text-xs">
        <a href="https://www.youtube.com/@English_Piranha" target="_blank"
           class="flex items-center gap-1 px-2 py-1 rounded-full border border-slate-200 hover:border-primary hover:text-primary">
          <span class="material-symbols-outlined text-base">play_circle</span> English Piranha
        </a>
        <a href="https://vokabelspiele2-hrnuxphzneec8lgser24mx.streamlit.app/" target="_blank"
           class="flex items-center gap-1 px-2 py-1 rounded-full border border-slate-200 hover:border-primary hover:text-primary">
          <span class="material-symbols-outlined text-base">translate</span> Vokabeltrainer
        </a>
        <button onclick="softReset()" class="ml-2 text-slate-400 hover:text-primary transition" title="Ansicht zurücksetzen">
          <span class="material-symbols-outlined">refresh</span>
        </button>
      </div>
    </div>
    <div class="relative border-b border-slate-200 bg-white">
      <div class="max-w-5xl mx-auto flex overflow-x-auto no-scrollbar py-2 px-2 gap-2" id="nav-container"></div>
      <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-white to-transparent pointer-events-none md:hidden"></div>
    </div>
  </header>

  <main class="flex-grow overflow-y-auto p-4 relative" id="main-content"></main>

  <div id="floating-action-container" class="fixed bottom-4 left-4 right-4 z-30 hidden">
    <div class="max-w-3xl mx-auto flex flex-col gap-2">
      <div id="tense-filter-bar" class="hidden bg-white border border-slate-200 rounded-2xl shadow-sm px-3 py-2 flex items-center justify-between text-xs">
        <span class="font-semibold text-slate-500 mr-2">Übungstyp:</span>
        <div class="flex gap-1">
          <button class="filter-btn px-3 py-1 rounded-full border text-[11px] font-semibold" data-filter="all">Alle</button>
          <button class="filter-btn px-3 py-1 rounded-full border text-[11px] font-semibold" data-filter="pos">Aussagen</button>
          <button class="filter-btn px-3 py-1 rounded-full border text-[11px] font-semibold" data-filter="neg">Verneinungen</button>
          <button class="filter-btn px-3 py-1 rounded-full border text-[11px] font-semibold" data-filter="ques">Fragen</button>
        </div>
      </div>
      <button onclick="reloadQuestions()"
              class="w-full bg-slate-800 text-white shadow-xl py-3.5 rounded-2xl font-bold active:scale-95 transition flex items-center justify-center gap-2 backdrop-blur-md bg-opacity-90 border border-slate-700/50">
        <span class="material-symbols-outlined">refresh</span>
        5 neue Sätze laden
      </button>
    </div>
  </div>

  <script>
    // =====================
    // 100 VERBEN (mit Kontext-Erweiterung für logische Sätze)
    // =====================
    const verbs = [
      { base: "accept", past: "accepted", pp: "accepted", ing: "accepting", inf: "to accept", obj: "the offer" },
      { base: "add", past: "added", pp: "added", ing: "adding", inf: "to add", obj: "some sugar" },
      { base: "answer", past: "answered", pp: "answered", ing: "answering", inf: "to answer", obj: "the question" },
      { base: "ask", past: "asked", pp: "asked", ing: "asking", inf: "to ask", obj: "for help" },
      { base: "bake", past: "baked", pp: "baked", ing: "baking", inf: "to bake", obj: "a cake" },
      { base: "bring", past: "brought", pp: "brought", ing: "bringing", inf: "to bring", obj: "some water" },
      { base: "build", past: "built", pp: "built", ing: "building", inf: "to build", obj: "a house" },
      { base: "buy", past: "bought", pp: "bought", ing: "buying", inf: "to buy", obj: "a new car" },
      { base: "call", past: "called", pp: "called", ing: "calling", inf: "to call", obj: "my friend" },
      { base: "carry", past: "carried", pp: "carried", ing: "carrying", inf: "to carry", obj: "the heavy bag" },
      { base: "change", past: "changed", pp: "changed", ing: "changing", inf: "to change", obj: "my clothes" },
      { base: "clean", past: "cleaned", pp: "cleaned", ing: "cleaning", inf: "to clean", obj: "the room" },
      { base: "climb", past: "climbed", pp: "climbed", ing: "climbing", inf: "to climb", obj: "the tree" },
      { base: "close", past: "closed", pp: "closed", ing: "closing", inf: "to close", obj: "the door" },
      { base: "come", past: "came", pp: "come", ing: "coming", inf: "to come", obj: "home" },
      { base: "cook", past: "cooked", pp: "cooked", ing: "cooking", inf: "to cook", obj: "dinner" },
      { base: "count", past: "counted", pp: "counted", ing: "counting", inf: "to count", obj: "the money" },
      { base: "cry", past: "cried", pp: "cried", ing: "crying", inf: "to cry", obj: "loudly" },
      { base: "dance", past: "danced", pp: "danced", ing: "dancing", inf: "to dance", obj: "at the party" },
      { base: "decide", past: "decided", pp: "decided", ing: "deciding", inf: "to decide", obj: "what to do" },
      { base: "describe", past: "described", pp: "described", ing: "describing", inf: "to describe", obj: "the picture" },
      { base: "do", past: "did", pp: "done", ing: "doing", inf: "to do", obj: "the homework" },
      { base: "draw", past: "drew", pp: "drawn", ing: "drawing", inf: "to draw", obj: "a picture" },
      { base: "drink", past: "drank", pp: "drunk", ing: "drinking", inf: "to drink", obj: "some tea" },
      { base: "drive", past: "drove", pp: "driven", ing: "driving", inf: "to drive", obj: "the car" },
      { base: "eat", past: "ate", pp: "eaten", ing: "eating", inf: "to eat", obj: "a pizza" },
      { base: "enjoy", past: "enjoyed", pp: "enjoyed", ing: "enjoying", inf: "to enjoy", obj: "the holiday" },
      { base: "explain", past: "explained", pp: "explained", ing: "explaining", inf: "to explain", obj: "the problem" },
      { base: "fall", past: "fell", pp: "fallen", ing: "falling", inf: "to fall", obj: "down the stairs" },
      { base: "feel", past: "felt", pp: "felt", ing: "feeling", inf: "to feel", obj: "happy" },
      { base: "fight", past: "fought", pp: "fought", ing: "fighting", inf: "to fight", obj: "for freedom" },
      { base: "find", past: "found", pp: "found", ing: "finding", inf: "to find", obj: "the key" },
      { base: "finish", past: "finished", pp: "finished", ing: "finishing", inf: "to finish", obj: "the work" },
      { base: "fly", past: "flew", pp: "flown", ing: "flying", inf: "to fly", obj: "to London" },
      { base: "forget", past: "forgot", pp: "forgotten", ing: "forgetting", inf: "to forget", obj: "the answer" },
      { base: "get", past: "got", pp: "got", ing: "getting", inf: "to get", obj: "a present" },
      { base: "give", past: "gave", pp: "given", ing: "giving", inf: "to give", obj: "him a book" },
      { base: "go", past: "went", pp: "gone", ing: "going", inf: "to go", obj: "to school" },
      { base: "grow", past: "grew", pp: "grown", ing: "growing", inf: "to grow", obj: "plants" },
      { base: "guess", past: "guessed", pp: "guessed", ing: "guessing", inf: "to guess", obj: "the number" },
      { base: "happen", past: "happened", pp: "happened", ing: "happening", inf: "to happen", obj: "suddenly" },
      { base: "hate", past: "hated", pp: "hated", ing: "hating", inf: "to hate", obj: "spinach" },
      { base: "have", past: "had", pp: "had", ing: "having", inf: "to have", obj: "a good idea" },
      { base: "hear", past: "heard", pp: "heard", ing: "hearing", inf: "to hear", obj: "a noise" },
      { base: "help", past: "helped", pp: "helped", ing: "helping", inf: "to help", obj: "my friends" },
      { base: "hold", past: "held", pp: "held", ing: "holding", inf: "to hold", obj: "the bag" },
      { base: "hope", past: "hoped", pp: "hoped", ing: "hoping", inf: "to hope", obj: "for the best" },
      { base: "invite", past: "invited", pp: "invited", ing: "inviting", inf: "to invite", obj: "all friends" },
      { base: "keep", past: "kept", pp: "kept", ing: "keeping", inf: "to keep", obj: "the secret" },
      { base: "know", past: "knew", pp: "known", ing: "knowing", inf: "to know", obj: "the answer" },
      { base: "laugh", past: "laughed", pp: "laughed", ing: "laughing", inf: "to laugh", obj: "at the joke" },
      { base: "learn", past: "learned", pp: "learned", ing: "learning", inf: "to learn", obj: "English" },
      { base: "leave", past: "left", pp: "left", ing: "leaving", inf: "to leave", obj: "the house" },
      { base: "lend", past: "lent", pp: "lent", ing: "lending", inf: "to lend", obj: "money" },
      { base: "listen", past: "listened", pp: "listened", ing: "listening", inf: "to listen", obj: "to music" },
      { base: "live", past: "lived", pp: "lived", ing: "living", inf: "to live", obj: "in Berlin" },
      { base: "look", past: "looked", pp: "looked", ing: "looking", inf: "to look", obj: "at the picture" },
      { base: "lose", past: "lost", pp: "lost", ing: "losing", inf: "to lose", obj: "the match" },
      { base: "love", past: "loved", pp: "loved", ing: "loving", inf: "to love", obj: "chocolate" },
      { base: "make", past: "made", pp: "made", ing: "making", inf: "to make", obj: "a mistake" },
      { base: "meet", past: "met", pp: "met", ing: "meeting", inf: "to meet", obj: "new people" },
      { base: "move", past: "moved", pp: "moved", ing: "moving", inf: "to move", obj: "to a new city" },
      { base: "need", past: "needed", pp: "needed", ing: "needing", inf: "to need", obj: "help" },
      { base: "open", past: "opened", pp: "opened", ing: "opening", inf: "to open", obj: "the window" },
      { base: "paint", past: "painted", pp: "painted", ing: "painting", inf: "to paint", obj: "a wall" },
      { base: "pay", past: "paid", pp: "paid", ing: "paying", inf: "to pay", obj: "the bill" },
      { base: "play", past: "played", pp: "played", ing: "playing", inf: "to play", obj: "football" },
      { base: "prepare", past: "prepared", pp: "prepared", ing: "preparing", inf: "to prepare", obj: "lunch" },
      { base: "put", past: "put", pp: "put", ing: "putting", inf: "to put", obj: "it on the table" },
      { base: "read", past: "read", pp: "read", ing: "reading", inf: "to read", obj: "a book" },
      { base: "remember", past: "remembered", pp: "remembered", ing: "remembering", inf: "to remember", obj: "the name" },
      { base: "ride", past: "rode", pp: "ridden", ing: "riding", inf: "to ride", obj: "a bike" },
      { base: "run", past: "ran", pp: "run", ing: "running", inf: "to run", obj: "in the park" },
      { base: "say", past: "said", pp: "said", ing: "saying", inf: "to say", obj: "hello" },
      { base: "see", past: "saw", pp: "seen", ing: "seeing", inf: "to see", obj: "a film" },
      { base: "sell", past: "sold", pp: "sold", ing: "selling", inf: "to sell", obj: "the old car" },
      { base: "send", past: "sent", pp: "sent", ing: "sending", inf: "to send", obj: "an email" },
      { base: "show", past: "showed", pp: "shown", ing: "showing", inf: "to show", obj: "the way" },
      { base: "sing", past: "sang", pp: "sung", ing: "singing", inf: "to sing", obj: "a song" },
      { base: "sit", past: "sat", pp: "sat", ing: "sitting", inf: "to sit", obj: "on the chair" },
      { base: "sleep", past: "slept", pp: "slept", ing: "sleeping", inf: "to sleep", obj: "well" },
      { base: "speak", past: "spoke", pp: "spoken", ing: "speaking", inf: "to speak", obj: "German" },
      { base: "spend", past: "spent", pp: "spent", ing: "spending", inf: "to spend", obj: "time" },
      { base: "stand", past: "stood", pp: "stood", ing: "standing", inf: "to stand", obj: "up" },
      { base: "start", past: "started", pp: "started", ing: "starting", inf: "to start", obj: "the game" },
      { base: "study", past: "studied", pp: "studied", ing: "studying", inf: "to study", obj: "maths" },
      { base: "swim", past: "swam", pp: "swum", ing: "swimming", inf: "to swim", obj: "in the lake" },
      { base: "take", past: "took", pp: "taken", ing: "taking", inf: "to take", obj: "the bus" },
      { base: "talk", past: "talked", pp: "talked", ing: "talking", inf: "to talk", obj: "to the teacher" },
      { base: "teach", past: "taught", pp: "taught", ing: "teaching", inf: "to teach", obj: "students" },
      { base: "tell", past: "told", pp: "told", ing: "telling", inf: "to tell", obj: "a story" },
      { base: "think", past: "thought", pp: "thought", ing: "thinking", inf: "to think", obj: "about it" },
      { base: "travel", past: "travelled", pp: "travelled", ing: "travelling", inf: "to travel", obj: "around the world" },
      { base: "try", past: "tried", pp: "tried", ing: "trying", inf: "to try", obj: "hard" },
      { base: "turn", past: "turned", pp: "turned", ing: "turning", inf: "to turn", obj: "around" },
      { base: "use", past: "used", pp: "used", ing: "using", inf: "to use", obj: "a computer" },
      { base: "wait", past: "waited", pp: "waited", ing: "waiting", inf: "to wait", obj: "for the bus" },
      { base: "walk", past: "walked", pp: "walked", ing: "walking", inf: "to walk", obj: "to school" },
      { base: "watch", past: "watched", pp: "watched", ing: "watching", inf: "to watch", obj: "TV" },
      { base: "work", past: "worked", pp: "worked", ing: "working", inf: "to work", obj: "hard" }
    ];

    // =====================
    // Subjekte (Bereinigt um unlogische wie "the dog" oder "it" für universelle Nutzung)
    // =====================
    const subjects = [
      { label: "I",            bePres: "am",  bePast: "was",  havePres: "have", is3sg: false },
      { label: "you",          bePres: "are", bePast: "were", havePres: "have", is3sg: false },
      { label: "he",           bePres: "is",  bePast: "was",  havePres: "has",  is3sg: true  },
      { label: "she",          bePres: "is",  bePast: "was",  havePres: "has",  is3sg: true  },
      { label: "we",           bePres: "are", bePast: "were", havePres: "have", is3sg: false },
      { label: "they",         bePres: "are", bePast: "were", havePres: "have", is3sg: false },
      { label: "my brother",   bePres: "is",  bePast: "was",  havePres: "has",  is3sg: true  },
      { label: "my sister",    bePres: "is",  bePast: "was",  havePres: "has",  is3sg: true  },
      { label: "my parents",   bePres: "are", bePast: "were", havePres: "have", is3sg: false },
      { label: "Tom",          bePres: "is",  bePast: "was",  havePres: "has",  is3sg: true  },
      { label: "Sarah",        bePres: "is",  bePast: "was",  havePres: "has",  is3sg: true  },
      { label: "the students", bePres: "are", bePast: "were", havePres: "have", is3sg: false }
    ];

    function present3sg(verb) {
      if (verb === "have") return "has";
      if (verb === "do")   return "does";
      if (verb === "go")   return "goes";
      if (verb.endsWith("y") && !"aeiou".includes(verb[verb.length - 2])) {
        return verb.slice(0, -1) + "ies";
      }
      if (["ch","sh","s","x","z","o"].some(end => verb.endsWith(end))) {
        return verb + "es";
      }
      return verb + "s";
    }

    function getRandomQuestions(allQuestions, count = 5) {
      const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    // =====================
    // TENSE-GENERATOREN (100 Aufgaben / Zeit)
    // =====================

    function generateSimplePresentPractice() {
      const timePhrases = ["every day.", "every morning.", "after school.", "on Mondays.", "at the weekend.", "in the evening."];
      const questionsTime = ["every day?", "every morning?", "after school?", "on Mondays?", "at the weekend?", "in the evening?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[i % subjects.length];
        const obj = verb.obj; // Kontext holen
        if (i < 34) {
          const time = timePhrases[i % timePhrases.length];
          const base = verb.base;
          const ans = subj.is3sg ? present3sg(base) : base;
          const hint = subj.is3sg ? "He/She/It: +s / -es / -ies" : "Grundform";
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${time}`;
          items.push({ type: "pos", q, a: ans, hint });
        } else if (i < 67) {
          const time = timePhrases[i % timePhrases.length];
          const base = verb.base;
          const aux = subj.is3sg ? "doesn't" : "don't";
          const hint = subj.is3sg ? "He/She/It: doesn't + Grundform" : "don't + Grundform";
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${time}`;
          const a = `${aux} ${base}`;
          items.push({ type: "neg", q, a, hint });
        } else {
          const time = questionsTime[i % questionsTime.length];
          const base = verb.base;
          const aux = subj.is3sg ? "Does" : "Do";
          const hint = `${aux} + Person + Grundform`;
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${time}`;
          const a = `${aux} ${subj.label} ${base}`;
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    function generateSimplePastPractice() {
      const timePhrases = ["yesterday.", "last week.", "last year.", "two days ago.", "in 2020.", "an hour ago."];
      const questionTime = ["yesterday?", "last week?", "last night?", "two days ago?", "on Monday?", "in 2020?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[(i * 2) % subjects.length];
        const obj = verb.obj;
        if (i < 34) {
          const time = timePhrases[i % timePhrases.length];
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${time}`;
          const a = verb.past;
          const hint = `${verb.base} → ${verb.past}`;
          items.push({ type: "pos", q, a, hint });
        } else if (i < 67) {
          const time = timePhrases[i % timePhrases.length];
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${time}`;
          const a = `didn't ${verb.base}`;
          const hint = "didn't + Grundform";
          items.push({ type: "neg", q, a, hint });
        } else {
          const time = questionTime[i % questionTime.length];
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${time}`;
          const a = `Did ${subj.label} ${verb.base}`;
          const hint = "Did + Person + Grundform";
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    function generatePresentProgressivePractice() {
      const timePhrases = ["now.", "at the moment.", "right now.", "today.", "this morning.", "this evening."];
      const questionTime = ["now?", "at the moment?", "right now?", "today?", "this morning?", "this evening?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[(i * 3) % subjects.length];
        const be = subj.bePres;
        const obj = verb.obj;
        if (i < 34) {
          const time = timePhrases[i % timePhrases.length];
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${time}`;
          const a = `${be} ${verb.ing}`;
          const hint = `${be} + Verb-ing`;
          items.push({ type: "pos", q, a, hint });
        } else if (i < 67) {
          const time = timePhrases[i % timePhrases.length];
          let aux, hint;
          if (be === "am") { aux = "am not"; hint = "am not + Verb-ing"; }
          else if (be === "is") { aux = "isn't"; hint = "isn't + Verb-ing"; }
          else { aux = "aren't"; hint = "aren't + Verb-ing"; }
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${time}`;
          const a = `${aux} ${verb.ing}`;
          items.push({ type: "neg", q, a, hint });
        } else {
          const time = questionTime[i % questionTime.length];
          let aux;
          if (be === "am") aux = "Am";
          else if (be === "is") aux = "Is";
          else aux = "Are";
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${time}`;
          const a = `${aux} ${subj.label} ${verb.ing}`;
          const hint = `${aux} + Person + Verb-ing`;
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    function generatePastProgressivePractice() {
      const timePhrases = ["yesterday at 5.", "when he called.", "while it rained.", "all evening.", "all day.", "at that moment."];
      const questionTime = ["yesterday at 5?", "when he called?", "while it rained?", "all evening?", "all day?", "at that moment?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[(i * 4) % subjects.length];
        const bePast = subj.bePast;
        const obj = verb.obj;
        if (i < 34) {
          const time = timePhrases[i % timePhrases.length];
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${time}`;
          const a = `${bePast} ${verb.ing}`;
          const hint = `${bePast} + Verb-ing`;
          items.push({ type: "pos", q, a, hint });
        } else if (i < 67) {
          const time = timePhrases[i % timePhrases.length];
          const aux = bePast === "was" ? "wasn't" : "weren't";
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${time}`;
          const a = `${aux} ${verb.ing}`;
          const hint = `${aux} + Verb-ing`;
          items.push({ type: "neg", q, a, hint });
        } else {
          const time = questionTime[i % questionTime.length];
          const aux = bePast === "was" ? "Was" : "Were";
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${time}`;
          const a = `${aux} ${subj.label} ${verb.ing}`;
          const hint = `${aux} + Person + Verb-ing`;
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    function generateWillFuturePractice() {
      const timePhrases = ["tomorrow.", "next week.", "next month.", "soon.", "later.", "this evening."];
      const questionTime = ["tomorrow?", "next week?", "next month?", "soon?", "later?", "this evening?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[(i * 5) % subjects.length];
        const obj = verb.obj;
        if (i < 34) {
          const time = timePhrases[i % timePhrases.length];
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${time}`;
          const a = `will ${verb.base}`;
          const hint = "will + Grundform";
          items.push({ type: "pos", q, a, hint });
        } else if (i < 67) {
          const time = timePhrases[i % timePhrases.length];
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${time}`;
          const a = `won't ${verb.base}`;
          const hint = "won't + Grundform";
          items.push({ type: "neg", q, a, hint });
        } else {
          const time = questionTime[i % questionTime.length];
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${time}`;
          const a = `Will ${subj.label} ${verb.base}`;
          const hint = "Will + Person + Grundform";
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    function generateGoingToFuturePractice() {
      const timePhrases = ["tomorrow.", "next week.", "next month.", "soon.", "later.", "this afternoon."];
      const questionTime = ["tomorrow?", "next week?", "next month?", "soon?", "later?", "this afternoon?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[(i * 6) % subjects.length];
        const be = subj.bePres;
        const obj = verb.obj;
        if (i < 34) {
          const time = timePhrases[i % timePhrases.length];
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${time}`;
          const a = `${be} going to ${verb.base}`;
          const hint = "am/is/are going to + Grundform";
          items.push({ type: "pos", q, a, hint });
        } else if (i < 67) {
          const time = timePhrases[i % timePhrases.length];
          let aux;
          if (be === "am") aux = "am not going to";
          else if (be === "is") aux = "isn't going to";
          else aux = "aren't going to";
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${time}`;
          const a = `${aux} ${verb.base}`;
          const hint = "am/is/are not going to + Grundform";
          items.push({ type: "neg", q, a, hint });
        } else {
          const time = questionTime[i % questionTime.length];
          let aux;
          if (be === "am") aux = "Am";
          else if (be === "is") aux = "Is";
          else aux = "Are";
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${time}`;
          const a = `${aux} ${subj.label} going to ${verb.base}`;
          const hint = "Am/Is/Are + Person + going to + Grundform";
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    function generatePresentPerfectPractice() {
      const endPos = ["already.", "just now.", "today.", "this week.", "many times.", "before."];
      const endNeg = ["yet.", "today.", "this week.", "so far.", "before.", "this year."];
      const endQ = ["yet?", "today?", "this week?", "before?", "so far?", "this year?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[(i * 7) % subjects.length];
        const obj = verb.obj;
        if (i < 34) {
          const end = endPos[i % endPos.length];
          const aux = subj.havePres;
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${end}`;
          const a = `${aux} ${verb.pp}`;
          const hint = `${aux} + 3. Form`;
          items.push({ type: "pos", q, a, hint });
        } else if (i < 67) {
          const end = endNeg[i % endNeg.length];
          const aux = subj.havePres === "has" ? "hasn't" : "haven't";
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${end}`;
          const a = `${aux} ${verb.pp}`;
          const hint = `${aux} + 3. Form`;
          items.push({ type: "neg", q, a, hint });
        } else {
          const end = endQ[i % endQ.length];
          const aux = subj.havePres === "has" ? "Has" : "Have";
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${end}`;
          const a = `${aux} ${subj.label} ${verb.pp}`;
          const hint = `${aux} + Person + 3. Form`;
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    function generatePastPerfectPractice() {
      const endPos = ["before I arrived.", "when the film started.", "before lunch.", "by 6 o'clock.", "before the test.", "when he called."];
      const endNeg = ["before I arrived.", "before the lesson.", "before lunch.", "by 6 o'clock.", "before the test.", "when he called."];
      const endQ = ["before I arrived?", "before the film started?", "before lunch?", "by 6 o'clock?", "before the test?", "when he called?"];
      const items = [];
      for (let i = 0; i < 100; i++) {
        const verb = verbs[i];
        const subj = subjects[(i * 8) % subjects.length];
        const obj = verb.obj;
        if (i < 34) {
          const end = endPos[i % endPos.length];
          const q = `${subj.label} _____ (${verb.inf}) ${obj} ${end}`;
          const a = `had ${verb.pp}`;
          const hint = "had + 3. Form";
          items.push({ type: "pos", q, a, hint });
        } else if (i < 67) {
          const end = endNeg[i % endNeg.length];
          const q = `${subj.label} _____ (not / ${verb.inf}) ${obj} ${end}`;
          const a = `hadn't ${verb.pp}`;
          const hint = "hadn't + 3. Form";
          items.push({ type: "neg", q, a, hint });
        } else {
          const end = endQ[i % endQ.length];
          const q = `_____ (${verb.inf} / ${subj.label}) ${obj} ${end}`;
          const a = `Had ${subj.label} ${verb.pp}`;
          const hint = "Had + Person + 3. Form";
          items.push({ type: "ques", q, a, hint });
        }
      }
      return items;
    }

    // =====================
    // GRAMMAR-THEMEN (100 Aufgaben)
    // =====================

    function generateIfClausesPractice() {
      const items = [];
      const type1Times = ["tomorrow", "next week", "this afternoon", "on Saturday", "next year"];
      const type2Phrases = ["more money", "a bigger house", "a car", "more free time", "a dog"];
      const type3Times = ["yesterday", "last week", "last year", "two days ago", "in 2020"];
      let i = 0;
      while (items.length < 100) {
        const verb = verbs[i % verbs.length];
        const subj = subjects[i % subjects.length];
        const obj = verb.obj;
        if (items.length % 3 === 0) {
          const time = type1Times[i % type1Times.length];
          const q = `If ${subj.label} _____ (${verb.inf}) ${obj} ${time}, ${subj.label} will ${verb.base} happy.`;
          const a = subj.is3sg ? present3sg(verb.base) : verb.base;
          const hint = "Type 1: If + Simple Present, will + Grundform";
          items.push({ type: "type1", q, a, hint });
        } else if (items.length % 3 === 1) {
          const wish = type2Phrases[i % type2Phrases.length];
          const q = `If ${subj.label} _____ (${verb.inf}) ${obj}, ${subj.label} would buy ${wish}.`;
          const a = verb.past;
          const hint = "Type 2: If + Simple Past, would + Grundform";
          items.push({ type: "type2", q, a, hint });
        } else {
          const time = type3Times[i % type3Times.length];
          const q = `If ${subj.label} _____ (${verb.inf}) ${obj} ${time}, ${subj.label} would have been happy.`;
          const a = `had ${verb.pp}`;
          const hint = "Type 3: If + Past Perfect, would have + 3. Form";
          items.push({ type: "type3", q, a, hint });
        }
        i++;
      }
      return items;
    }

    function generateComparativesPractice() {
      const items = [];
      const adjectives = [
        { base: "tall",        comp: "taller",           sup: "the tallest" },
        { base: "small",       comp: "smaller",          sup: "the smallest" },
        { base: "fast",        comp: "faster",           sup: "the fastest" },
        { base: "slow",        comp: "slower",           sup: "the slowest" },
        { base: "old",         comp: "older",            sup: "the oldest" },
        { base: "young",       comp: "younger",          sup: "the youngest" },
        { base: "interesting", comp: "more interesting", sup: "the most interesting" },
        { base: "boring",      comp: "more boring",      sup: "the most boring" },
        { base: "good",        comp: "better",           sup: "the best" },
        { base: "bad",         comp: "worse",            sup: "the worst" },
        { base: "cheap",       comp: "cheaper",          sup: "the cheapest" },
        { base: "expensive",   comp: "more expensive",   sup: "the most expensive" }
      ];
      for (let i = 0; i < 100; i++) {
        const adj = adjectives[i % adjectives.length];
        if (i < 50) {
          const q = `Tom is _____ (${adj.base}) than Jim.`;
          const a = adj.comp;
          const hint = "Comparative: -er oder more + Adjektiv";
          items.push({ type: "mix", q, a, hint });
        } else {
          const q = `This is _____ (${adj.base}) book in the class.`;
          const a = adj.sup;
          const hint = "Superlative: the + -est / the most ...";
          items.push({ type: "mix", q, a, hint });
        }
      }
      return items;
    }

    function generateQuestionFormationPractice() {
      const baseTemplates = [
        { q: "_____ (you / to like) pizza?",              a: "Do you like",            hint: "Do + you + Grundform" },
        { q: "_____ (she / to play) tennis?",             a: "Does she play",          hint: "Does + she + Grundform" },
        { q: "Where _____ (they / to live)?",             a: "do they live",           hint: "Fragewort + do/does" },
        { q: "When _____ (he / to get up)?",              a: "does he get up",         hint: "When + does + he" },
        { q: "_____ (you / to go) to school yesterday?",  a: "Did you go",             hint: "Did + Grundform" },
        { q: "Why _____ (she / to cry) yesterday?",       a: "did she cry",            hint: "Why + did + she" },
        { q: "_____ (they / to be) at home yesterday?",   a: "Were they",              hint: "to be im Simple Past" },
        { q: "Where _____ (she / to be) now?",            a: "is she",                 hint: "Fragewort + be" },
        { q: "What _____ (you / to do) now?",             a: "are you doing",          hint: "Present Progressive" },
        { q: "What _____ (she / to do) at the moment?",   a: "is she doing",           hint: "is + she + Verb-ing" },
        { q: "How long _____ (you / to live) here?",      a: "have you lived",         hint: "Present Perfect" },
        { q: "_____ (he / to have) a dog?",               a: "Does he have",           hint: "have als Vollverb" },
        { q: "Who _____ (to help) you with your homework?", a: "helps",                hint: "Who + Verb (kein do/does)" },
        { q: "What time _____ (the film / to start)?",    a: "does the film start",    hint: "Fragewort + does" },
        { q: "Why _____ (they / to be) late?",            a: "are they",               hint: "be vor dem Subjekt" }
      ];
      const items = [];
      let i = 0;
      while (items.length < 100) {
        const t = baseTemplates[i % baseTemplates.length];
        items.push({ type: "ques", q: t.q, a: t.a, hint: t.hint });
        i++;
      }
      return items;
    }

    function generateModalVerbsPractice() {
      const baseTemplates = [
        { q: "You _____ (can) swim very well.",                     a: "can",        hint: "Modalverb + Grundform" },
        { q: "She _____ (must) do her homework.",                   a: "must",       hint: "starke Pflicht" },
        { q: "We _____ (should) help our parents.",                 a: "should",     hint: "Rat geben" },
        { q: "They _____ (must not) be late.",                      a: "must not",   hint: "Verbot: mustn't" },
        { q: "I _____ (may) go to the party.",                      a: "may",        hint: "vielleicht dürfen" },
        { q: "You _____ (should not) eat so much fast food.",       a: "should not", hint: "shouldn't" },
        { q: "He _____ (can't) play the piano.",                    a: "can't",      hint: "can not" },
        { q: "We _____ (might) see him tomorrow.",                  a: "might",      hint: "unsichere Möglichkeit" },
        { q: "You _____ (must) wear a helmet.",                     a: "must",       hint: "Regel oder Gesetz" },
        { q: "Students _____ (must not) use their phones in the exam.", a: "must not", hint: "strenges Verbot" },
        { q: "You _____ (can) ask your teacher for help.",          a: "can",        hint: "Erlaubnis / Möglichkeit" },
        { q: "She _____ (should) drink more water.",                a: "should",     hint: "Gesundheitstipp" }
      ];
      const items = [];
      let i = 0;
      while (items.length < 100) {
        const t = baseTemplates[i % baseTemplates.length];
        items.push({ type: "mix", q: t.q, a: t.a, hint: t.hint });
        i++;
      }
      return items;
    }

    function generateMuchManyPractice() {
      const baseTemplates = [
        { q: "There isn't _____ water in the glass.",   a: "much", hint: "uncountable → much" },
        { q: "How _____ apples do you want?",           a: "many", hint: "zählbar → many" },
        { q: "She has too _____ homework.",             a: "much", hint: "homework = uncountable" },
        { q: "There are _____ books on the table.",     a: "many", hint: "Plural → many" },
        { q: "We don't have _____ time.",               a: "much", hint: "time = uncountable" },
        { q: "I have _____ friends in London.",         a: "many", hint: "friends = plural" },
        { q: "How _____ sugar do you put in your tea?", a: "much", hint: "sugar = uncountable" },
        { q: "How _____ students are in your class?",   a: "many", hint: "students = plural" },
        { q: "There isn't _____ milk left in the fridge.", a: "much", hint: "milk = uncountable" },
        { q: "He has _____ CDs at home.",               a: "many", hint: "CDs = plural" }
      ];
      const items = [];
      let i = 0;
      while (items.length < 100) {
        const t = baseTemplates[i % baseTemplates.length];
        items.push({ type: "mix", q: t.q, a: t.a, hint: t.hint });
        i++;
      }
      return items;
    }

    function generateWordOrderPractice() {
      const baseTemplates = [
        {
          q: "Ordne die Wörter zu einem richtigen Satz:\n(always / does / her homework / she / in the evening)",
          a: "She always does her homework in the evening.",
          hint: "Subjekt – Adverb – Verb – Rest."
        },
        {
          q: "Ordne die Wörter:\n(often / we / play / football / after school)",
          a: "We often play football after school.",
          hint: "Adverb vor dem Vollverb."
        },
        {
          q: "Ordne die Wörter:\n(never / is / he / late / for school)",
          a: "He is never late for school.",
          hint: "Adverb nach be."
        },
        {
          q: "Ordne die Wörter:\n(in the morning / I / usually / get up / at 7 o'clock)",
          a: "I usually get up at 7 o'clock in the morning.",
          hint: "Zeitangaben meistens am Ende."
        },
        {
          q: "Ordne die Wörter:\n(English / on Mondays / we / have / always)",
          a: "We always have English on Mondays.",
          hint: "Subjekt – Adverb – Verb – Objekt – Zeit."
        },
        {
          q: "Ordne die Wörter:\n(sometimes / in the park / they / play / football)",
          a: "They sometimes play football in the park.",
          hint: "Ort oft vor Zeit."
        },
        {
          q: "Ordne die Wörter:\n(at the weekend / go / we / usually / to my grandma's house)",
          a: "We usually go to my grandma's house at the weekend.",
          hint: "Häufigkeitsadverb vor dem Vollverb."
        },
        {
          q: "Ordne die Wörter:\n(in the afternoon / is / very tired / my father / often)",
          a: "My father is often very tired in the afternoon.",
          hint: "Adverb nach be."
        },
        {
          q: "Ordne die Wörter:\n(always / wears / at school / she / her school uniform)",
          a: "She always wears her school uniform at school.",
          hint: "Subjekt – Adverb – Verb – Objekt – Ort."
        },
        {
          q: "Ordne die Wörter:\n(watches / in the evening / TV / usually / he)",
          a: "He usually watches TV in the evening.",
          hint: "Häufigkeit vor dem Vollverb."
        }
      ];
      const items = [];
      let i = 0;
      while (items.length < 100) {
        const t = baseTemplates[i % baseTemplates.length];
        items.push({ type: "mix", q: t.q, a: t.a, hint: t.hint });
        i++;
      }
      return items;
    }

    function generateReportedSpeechPractice() {
      const baseTemplates = [
        { q: "I am tired. → She said that she _____ tired.",                   a: "was",            hint: "am → was" },
        { q: "I like football. → He said that he _____ football.",             a: "liked",          hint: "like → liked" },
        { q: "We are going to London. → They said that they _____ going to London.", a: "were",   hint: "are → were" },
        { q: "I have finished. → She said that she _____ finished.",           a: "had",            hint: "have → had" },
        { q: "I will help you. → Tom said that he _____ help me.",             a: "would",          hint: "will → would" },
        { q: "I can swim. → He said that he _____ swim.",                      a: "could",          hint: "can → could" },
        { q: "I must go now. → She said that she _____ go then.",              a: "had to",         hint: "must → had to" },
        { q: "We are happy. → They said that they _____ happy.",               a: "were",           hint: "are → were" },
        { q: "I don't know. → She said that she _____ know.",                  a: "didn't",         hint: "don't → didn't" },
        { q: "I saw her yesterday. → He said that he had seen her _____.",     a: "the day before", hint: "yesterday → the day before" },
        { q: "I will see you tomorrow. → She said that she would see me _____.", a: "the next day", hint: "tomorrow → the next day" },
        { q: "Where do you live? → He asked where I _____.",                   a: "lived",          hint: "do + live → lived" },
        { q: "Do you like apples? → He asked if I _____ apples.",              a: "liked",          hint: "do you like → if I liked" },
        { q: "Are you ready? → They asked if I _____ ready.",                  a: "was",            hint: "are → was" },
        { q: "Can you help me? → He asked if I _____ help him.",               a: "could",          hint: "can → could" }
      ];
      const items = [];
      let i = 0;
      while (items.length < 100) {
        const t = baseTemplates[i % baseTemplates.length];
        items.push({ type: "mix", q: t.q, a: t.a, hint: t.hint });
        i++;
      }
      return items;
    }

    // =====================
    // PRACTICE-POOLS
    // =====================

    const practicePools = {
      "simple-present":       generateSimplePresentPractice(),
      "simple-past":          generateSimplePastPractice(),
      "present-progressive":  generatePresentProgressivePractice(),
      "past-progressive":     generatePastProgressivePractice(),
      "will-future":          generateWillFuturePractice(),
      "going-to-future":      generateGoingToFuturePractice(),
      "present-perfect":      generatePresentPerfectPractice(),
      "past-perfect":         generatePastPerfectPractice(),
      "if-clauses":           generateIfClausesPractice(),
      "comparatives":         generateComparativesPractice(),
      "questions":            generateQuestionFormationPractice(),
      "modals":               generateModalVerbsPractice(),
      "much-many":            generateMuchManyPractice(),
      "word-order":           generateWordOrderPractice(),
      "reported-speech":      generateReportedSpeechPractice()
    };

    // =====================
    // Erklärungen (gekürzt, aber strukturgleich)
    // =====================

    const appData = [
      {
        id: "simple-present",
        isTense: true,
        name: "Simple Present",
        color: "from-blue-600 to-cyan-500",
        learn: {
          intro: "Simple Present benutzt du für Dinge, die immer oder regelmäßig passieren.",
          bullets: [
            "Regelmäßige Handlungen",
            "Fakten und Eigenschaften",
            "Fahrpläne und wiederkehrende Zeiten"
          ],
          positive: {
            title: "Aussagen",
            rule: "Subjekt + Verb (he/she/it: Verb + -s).",
            explanation: "In der 3. Person Singular bekommt das Verb ein -s oder -es.",
            examples: [
              "I play football after school.",
              "He reads a book in the evening."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "Subjekt + don't / doesn't + Grundform.",
            explanation: "Nach don't / doesn't steht immer die Grundform.",
            examples: [
              "I don't like carrots.",
              "She doesn't play tennis."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Do / Does + Subjekt + Grundform?",
            explanation: "Do/does steht am Anfang der Frage.",
            examples: [
              "Do you play football?",
              "Does she live in London?"
            ]
          }
        },
        practice: practicePools["simple-present"]
      },
      {
        id: "simple-past",
        isTense: true,
        name: "Simple Past",
        color: "from-emerald-600 to-teal-500",
        learn: {
          intro: "Simple Past beschreibt abgeschlossene Handlungen in der Vergangenheit.",
          bullets: [
            "Zeitpunkt ist klar: yesterday, last week ...",
            "Handlung ist vorbei"
          ],
          positive: {
            title: "Aussagen",
            rule: "Regelmäßig: Verb + -ed; unregelmäßig: 2. Spalte.",
            explanation: "Alle Personen benutzen die gleiche Past-Form.",
            examples: [
              "I watched TV yesterday.",
              "They went to the park."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "Subjekt + didn't + Grundform.",
            explanation: "Nach didn't steht wieder die Grundform.",
            examples: [
              "I didn't play football.",
              "He didn't go home."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Did + Subjekt + Grundform?",
            explanation: "Did steht vorne, das Verb bleibt in der Grundform.",
            examples: [
              "Did you see the film?",
              "Where did they go?"
            ]
          }
        },
        practice: practicePools["simple-past"]
      },
      {
        id: "present-progressive",
        isTense: true,
        name: "Present Progressive",
        color: "from-indigo-600 to-purple-500",
        learn: {
          intro: "Present Progressive zeigt, was gerade jetzt passiert.",
          bullets: [
            "Handlungen im Moment des Sprechens",
            "Vorübergehende Situationen"
          ],
          positive: {
            title: "Aussagen",
            rule: "am / is / are + Verb-ing",
            explanation: "Beachte die richtige Form von be.",
            examples: [
              "I am reading a book.",
              "They are playing football."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "am not / isn't / aren't + Verb-ing",
            explanation: "Verneint wird die Form von be.",
            examples: [
              "He isn't doing his homework.",
              "We aren't listening."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Am / Is / Are + Subjekt + Verb-ing?",
            explanation: "Be steht hier am Anfang.",
            examples: [
              "Are you reading?",
              "What is she doing?"
            ]
          }
        },
        practice: practicePools["present-progressive"]
      },
      {
        id: "past-progressive",
        isTense: true,
        name: "Past Progressive",
        color: "from-green-600 to-lime-600",
        learn: {
          intro: "Past Progressive beschreibt eine längere Handlung in der Vergangenheit.",
          bullets: [
            "Lange Handlung, oft durch Simple Past unterbrochen",
            "Zeitpunkt ist meist angegeben"
          ],
          positive: {
            title: "Aussagen",
            rule: "was / were + Verb-ing",
            explanation: "was für I/he/she/it, were für you/we/they.",
            examples: [
              "I was reading when he came in.",
              "They were playing all afternoon."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "wasn't / weren't + Verb-ing",
            explanation: "Verneint wird wieder be.",
            examples: [
              "He wasn't sleeping.",
              "They weren't watching TV."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Was / Were + Subjekt + Verb-ing?",
            explanation: "Was/were stehen am Anfang.",
            examples: [
              "Were you sleeping at 8?",
              "What were they doing?"
            ]
          }
        },
        practice: practicePools["past-progressive"]
      },
      {
        id: "will-future",
        isTense: true,
        name: "Will-Future",
        color: "from-violet-600 to-fuchsia-600",
        learn: {
          intro: "Will-Future benutzt du für Vorhersagen und spontane Entscheidungen.",
          bullets: [
            "Entscheidung im Moment",
            "Vorhersagen über die Zukunft"
          ],
          positive: {
            title: "Aussagen",
            rule: "will + Grundform",
            explanation: "will ist für alle Personen gleich.",
            examples: [
              "I will help you.",
              "It will rain tomorrow."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "will not / won't + Grundform",
            explanation: "Kurzform: won't.",
            examples: [
              "I won't go there.",
              "He will not tell you."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Will + Subjekt + Grundform?",
            explanation: "Will steht am Anfang.",
            examples: [
              "Will you help me?",
              "When will they arrive?"
            ]
          }
        },
        practice: practicePools["will-future"]
      },
      {
        id: "going-to-future",
        isTense: true,
        name: "Going-to Future",
        color: "from-pink-600 to-rose-500",
        learn: {
          intro: "Going-to Future steht für fest geplante Zukunft oder klare Anzeichen.",
          bullets: [
            "feste Pläne",
            "logische Folgen (man sieht schon etwas)"
          ],
          positive: {
            title: "Aussagen",
            rule: "am / is / are + going to + Grundform",
            explanation: "Kombination aus be + going to + Verb.",
            examples: [
              "We are going to visit grandma.",
              "He is going to fall."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "am not / isn't / aren't going to + Grundform",
            explanation: "Wieder wird be verneint.",
            examples: [
              "I am not going to buy that.",
              "They aren't going to stay."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Am / Is / Are + Subjekt + going to + Grundform?",
            explanation: "Be steht vorn.",
            examples: [
              "Are you going to watch the game?",
              "What is she going to wear?"
            ]
          }
        },
        practice: practicePools["going-to-future"]
      },
      {
        id: "present-perfect",
        isTense: true,
        name: "Present Perfect",
        color: "from-orange-500 to-amber-500",
        learn: {
          intro: "Present Perfect verbindet Vergangenheit und Gegenwart.",
          bullets: [
            "Ergebnis ist jetzt wichtig",
            "Zeitpunkt ist unklar oder unwichtig"
          ],
          positive: {
            title: "Aussagen",
            rule: "have / has + 3. Form",
            explanation: "have für I/you/we/they, has für he/she/it.",
            examples: [
              "I have finished my homework.",
              "She has seen the film."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "haven't / hasn't + 3. Form",
            explanation: "Verneint wird have/has.",
            examples: [
              "I haven't done it yet.",
              "He hasn't called yet."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Have / Has + Subjekt + 3. Form?",
            explanation: "Have/has steht am Anfang.",
            examples: [
              "Have you done your homework?",
              "Has he finished?"
            ]
          }
        },
        practice: practicePools["present-perfect"]
      },
      {
        id: "past-perfect",
        isTense: true,
        name: "Past Perfect",
        color: "from-red-600 to-orange-600",
        learn: {
          intro: "Past Perfect: etwas war schon passiert, bevor etwas anderes passierte.",
          bullets: [
            "Vorvergangenheit",
            "oft zusammen mit Simple Past"
          ],
          positive: {
            title: "Aussagen",
            rule: "had + 3. Form",
            explanation: "had für alle Personen.",
            examples: [
              "She had done her homework before she went out.",
              "We had eaten when he arrived."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "hadn't + 3. Form",
            explanation: "Kurzform: hadn't.",
            examples: [
              "I hadn't seen him before.",
              "They hadn't finished."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Had + Subjekt + 3. Form?",
            explanation: "Had steht vorn.",
            examples: [
              "Had you done it before 8?",
              "Had she seen the film?"
            ]
          }
        },
        practice: practicePools["past-perfect"]
      },
      {
        id: "if-clauses",
        isTense: false,
        name: "If-Sätze (1–3)",
        color: "from-sky-600 to-emerald-500",
        learn: {
          intro: "If-Sätze beschreiben Bedingungen.",
          bullets: [
            "Type 1: reale Zukunft",
            "Type 2: unreale Gegenwart/Zukunft",
            "Type 3: unreale Vergangenheit"
          ],
          positive: {
            title: "Type 1",
            rule: "If + Simple Present, will + Grundform",
            explanation: "Die Bedingung ist möglich.",
            examples: [
              "If it rains, we will stay at home."
            ]
          },
          negative: {
            title: "Type 2",
            rule: "If + Simple Past, would + Grundform",
            explanation: "Unrealistische oder gedachte Situation.",
            examples: [
              "If I had more time, I would travel more."
            ]
          },
          question: {
            title: "Type 3",
            rule: "If + Past Perfect, would have + 3. Form",
            explanation: "Nicht mehr änderbare Vergangenheit.",
            examples: [
              "If she had worked harder, she would have passed."
            ]
          }
        },
        practice: practicePools["if-clauses"]
      },
      {
        id: "comparatives",
        isTense: false,
        name: "Comparatives",
        color: "from-yellow-500 to-orange-500",
        learn: {
          intro: "Mit Steigerungen vergleichst du Dinge.",
          bullets: [
            "Comparative: Vergleich von zwei Dingen",
            "Superlative: das „meiste“ oder „wenigste“"
          ],
          positive: {
            title: "Comparative",
            rule: "kurz: -er, lang: more + Adjektiv",
            explanation: "good → better, bad → worse.",
            examples: [
              "Tom is taller than Jim.",
              "This book is more interesting."
            ]
          },
          negative: {
            title: "Superlative",
            rule: "kurz: the + -est, lang: the most + Adjektiv",
            explanation: "Immer mit the.",
            examples: [
              "He is the tallest student.",
              "This is the best film."
            ]
          },
          question: {
            title: "Fehler",
            rule: "Nie more + -er oder most + -est.",
            explanation: "Entweder -er/-est oder more/most.",
            examples: [
              "NOT: more easier → easier"
            ]
          }
        },
        practice: practicePools["comparatives"]
      },
      {
        id: "questions",
        isTense: false,
        name: "Fragebildung",
        color: "from-cyan-600 to-blue-500",
        learn: {
          intro: "Englische Fragen brauchen meist ein Hilfsverb vor dem Subjekt.",
          bullets: [
            "Ja/Nein-Fragen: Hilfsverb + Subjekt + Verb",
            "Wh-Fragen: Fragewort + Hilfsverb + Subjekt + Verb"
          ],
          positive: {
            title: "Ja/Nein-Fragen",
            rule: "Do/does/did oder be/can/have + Subjekt",
            explanation: "Wenn schon ein Hilfsverb da ist, kein do/does/did mehr.",
            examples: [
              "Do you like cats?",
              "Is she at home?"
            ]
          },
          negative: {
            title: "Wh-Fragen",
            rule: "Fragewort + Hilfsverb + Subjekt + Verb",
            explanation: "Reihenfolge bleibt gleich wie bei Ja/Nein-Fragen.",
            examples: [
              "Where do you live?",
              "When does the film start?"
            ]
          },
          question: {
            title: "Typischer Fehler",
            rule: "Nicht zwei Hilfsverben stapeln.",
            explanation: "NICHT: Where do you are? → Where are you?",
            examples: [
              "Where are you?"
            ]
          }
        },
        practice: practicePools["questions"]
      },
      {
        id: "modals",
        isTense: false,
        name: "Modalverben",
        color: "from-slate-700 to-slate-500",
        learn: {
          intro: "Modalverben drücken Fähigkeit, Pflicht, Erlaubnis oder Möglichkeit aus.",
          bullets: [
            "can, could – Fähigkeit/Möglichkeit",
            "must, have to – Pflicht",
            "should – Rat",
            "may, might – Möglichkeit/Erlaubnis"
          ],
          positive: {
            title: "Form",
            rule: "Subjekt + Modalverb + Grundform",
            explanation: "Modalverben haben kein -s in der 3. Person.",
            examples: [
              "He can swim.",
              "You should study."
            ]
          },
          negative: {
            title: "Verneinungen",
            rule: "Modalverb + not",
            explanation: "Kurzformen: can't, mustn't, shouldn't ...",
            examples: [
              "You mustn't smoke here.",
              "She can't drive."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Modalverb + Subjekt + Grundform?",
            explanation: "Modalverb steht vorn.",
            examples: [
              "Can you help me?",
              "Should we go now?"
            ]
          }
        },
        practice: practicePools["modals"]
      },
      {
        id: "much-many",
        isTense: false,
        name: "Much / Many",
        color: "from-lime-500 to-emerald-500",
        learn: {
          intro: "Im Deutschen oft alles „viel“. Englisch unterscheidet.",
          bullets: [
            "many + zählbare Nomen (Plural)",
            "much + unzählbare Nomen"
          ],
          positive: {
            title: "many",
            rule: "many + plural countable noun",
            explanation: "Du kannst die Dinge zählen.",
            examples: [
              "How many books do you have?"
            ]
          },
          negative: {
            title: "much",
            rule: "much + uncountable noun",
            explanation: "keine Pluralform.",
            examples: [
              "We don't have much time."
            ]
          },
          question: {
            title: "a lot of",
            rule: "funktioniert mit beidem",
            explanation: "oft im positiven Satz.",
            examples: [
              "I have a lot of friends.",
              "She drinks a lot of water."
            ]
          }
        },
        practice: practicePools["much-many"]
      },
      {
        id: "word-order",
        isTense: false,
        name: "Satzbau",
        color: "from-amber-600 to-red-500",
        learn: {
          intro: "Englische Wortstellung ist relativ starr.",
          bullets: [
            "Grundfolge: Subjekt – Verb – Objekt – Ort – Zeit",
            "Häufigkeitsadverbien meist vor dem Vollverb"
          ],
          positive: {
            title: "Grundstellung",
            rule: "S – V – O – Ort – Zeit",
            explanation: "Nicht wie im Deutschen wild umstellen.",
            examples: [
              "She reads a book in her room every evening."
            ]
          },
          negative: {
            title: "Adverbien",
            rule: "Adverb vor dem Vollverb, nach be.",
            explanation: "always, usually, often, sometimes, never ...",
            examples: [
              "He is never late.",
              "We often play football."
            ]
          },
          question: {
            title: "Typische Fehler",
            rule: "Nicht zu viele Angaben in die Mitte quetschen.",
            explanation: "Lieber: S – V – O – Ort – Zeit.",
            examples: [
              "We play football in the park on Fridays."
            ]
          }
        },
        practice: practicePools["word-order"]
      },
      {
        id: "reported-speech",
        isTense: false,
        name: "Indirekte Rede",
        color: "from-slate-600 to-indigo-600",
        learn: {
          intro: "Du gibst wieder, was jemand gesagt hat, ohne wörtlich zu zitieren.",
          bullets: [
            "oft Zeitverschiebung (backshift)",
            "Pronomen und Zeitangaben ändern sich"
          ],
          positive: {
            title: "Aussagen",
            rule: "say/tell + that-Satz",
            explanation: "tell braucht eine Person: He told me that ...",
            examples: [
              "\"I am tired.\" → She said that she was tired."
            ]
          },
          negative: {
            title: "Zeitverschiebung",
            rule: "am/is → was, are → were, will → would, have → had",
            explanation: "wenn Einleitung in Past (said, told).",
            examples: [
              "\"I will help you.\" → He said that he would help me."
            ]
          },
          question: {
            title: "Fragen",
            rule: "Fragewort + if/whether + normale Satzstellung",
            explanation: "keine Fragewort-Stellung mehr.",
            examples: [
              "\"Do you like apples?\" → He asked if I liked apples."
            ]
          }
        },
        practice: practicePools["reported-speech"]
      }
    ];

    // =====================
    // UI-STATUS UND FUNKTIONEN
    // =====================

    let currentTenseIndex = 0;
    let currentMode = "learn";
    let currentQuestions = [];
    let currentPracticeFilter = "all";

    const navContainer = document.getElementById("nav-container");
    const mainContent  = document.getElementById("main-content");
    const floatingContainer = document.getElementById("floating-action-container");
    const filterBar = document.getElementById("tense-filter-bar");

    function getRandomQuestionsFromPool(data) {
      const practicePool = data.practice;
      let pool = practicePool;

      if (data.isTense && currentPracticeFilter !== "all") {
        const filtered = practicePool.filter(item => item.type === currentPracticeFilter);
        if (filtered.length >= 5) pool = filtered;
      }
      return getRandomQuestions(pool, 5);
    }

    function init() {
      renderNav();
      renderContent();
    }

    window.onload = function () {
      if (appData.length > 0) {
        init();
      } else {
        document.body.innerHTML = "<div class='p-10 text-red-600 font-bold text-center'>Fehler: keine Daten geladen.</div>";
      }
    };

    function renderNav() {
      navContainer.innerHTML = "";
      appData.forEach((topic, index) => {
        const isActive = index === currentTenseIndex;
        const btn = document.createElement("button");
        btn.className =
          "px-4 py-2.5 rounded-full text-xs md:text-sm font-bold transition-all whitespace-nowrap flex-shrink-0 border-2 " +
          (isActive
            ? `bg-gradient-to-r ${topic.color} text-white border-transparent shadow-lg transform scale-105`
            : "bg-white text-slate-500 border-slate-200 hover:border-slate-300 hover:bg-slate-50");
        btn.textContent = topic.name;
        btn.onclick = () => {
          currentTenseIndex = index;
          currentMode = "learn";
          currentQuestions = [];
          currentPracticeFilter = "all";
          renderNav();
          renderContent();
        };
        navContainer.appendChild(btn);
      });
    }

    function renderContent() {
      const data = appData[currentTenseIndex];

      mainContent.innerHTML = "";
      const container = document.createElement("div");
      container.className = "max-w-4xl mx-auto fade-in pb-32";

      const banner = `
        <div class="rounded-2xl bg-gradient-to-r ${data.color} p-6 text-white shadow-lg mb-6 relative overflow-hidden">
          <div class="relative z-10">
            <h2 class="text-3xl font-extrabold tracking-tight mb-2">${data.name}</h2>
            <p class="opacity-90 font-medium mb-2">${data.learn.intro}</p>
            <ul class="text-sm opacity-90 list-disc ml-4 space-y-1">
              ${data.learn.bullets.map(b => `<li>${b}</li>`).join("")}
            </ul>
          </div>
          <span class="material-symbols-outlined absolute -right-4 -bottom-6 text-9xl opacity-20 rotate-12">menu_book</span>
        </div>
      `;

      const modeSwitcher = `
        <div class="bg-white p-1.5 rounded-xl shadow-sm border border-slate-200 mb-6 flex">
          <button onclick="switchMode('learn')"
                  class="flex-1 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${currentMode === "learn" ? "bg-slate-100 text-slate-800 shadow-inner" : "text-slate-500 hover:text-slate-700"}">
            <span class="material-symbols-outlined">menu_book</span> Erklären
          </button>
          <button onclick="switchMode('practice')"
                  class="flex-1 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${currentMode === "practice" ? "bg-slate-100 text-slate-800 shadow-inner" : "text-slate-500 hover:text-slate-700"}">
            <span class="material-symbols-outlined">edit_note</span> Üben
          </button>
        </div>
      `;

      let contentHTML = "";

      if (currentMode === "learn") {
        floatingContainer.classList.add("hidden");
        filterBar.classList.add("hidden");

        const createCard = (block, icon, colorClass, textClass) => `
          <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
            <div class="${colorClass} px-4 py-3 flex items-center gap-2 border-b border-slate-100">
              <span class="material-symbols-outlined text-white">${icon}</span>
              <span class="font-bold text-white uppercase text-sm tracking-wider">${block.title}</span>
            </div>
            <div class="p-5 space-y-3">
              <p class="font-mono text-base md:text-lg font-medium ${textClass} bg-slate-50 p-3 rounded-lg border border-slate-100">
                ${block.rule}
              </p>
              <p class="text-sm text-slate-700 leading-relaxed">${block.explanation}</p>
              <div class="space-y-1">
                ${block.examples.map(ex => `
                  <div class="text-slate-700 text-sm flex gap-2">
                    <span class="text-slate-400">•</span> ${ex}
                  </div>`).join("")}
              </div>
            </div>
          </div>
        `;

        contentHTML = `
          <div class="space-y-6">
            ${createCard(data.learn.positive, "add_circle", "bg-green-500", "text-green-700")}
            ${createCard(data.learn.negative, "cancel", "bg-red-500", "text-red-700")}
            ${createCard(data.learn.question, "help", "bg-blue-500", "text-blue-700")}
          </div>
        `;
      } else {
        floatingContainer.classList.remove("hidden");

        if (data.isTense) {
          filterBar.classList.remove("hidden");
          updateFilterButtons();
        } else {
          filterBar.classList.add("hidden");
        }

        if (currentQuestions.length === 0) {
          currentQuestions = getRandomQuestionsFromPool(data);
        }

        const practicePool = data.practice;
        const poolSize = practicePool.length;

        contentHTML = `
          <div class="space-y-4">
            <div class="flex justify-between items-center text-xs text-slate-400 font-medium">
              <span>Aufgaben im Pool: ${poolSize}</span>
              ${data.isTense
                ? `<span>Filter: ${
                    currentPracticeFilter === "all"
                      ? "alle Typen"
                      : currentPracticeFilter === "pos"
                      ? "nur Aussagen"
                      : currentPracticeFilter === "neg"
                      ? "nur Verneinungen"
                      : "nur Fragen"
                  }</span>`
                : ""}
            </div>
            ${currentQuestions.map((item, idx) => `
              <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 transition-all focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 relative overflow-hidden">
                ${
                  data.isTense
                    ? `<div class="absolute top-0 right-0 px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-bl-xl ${
                        item.type === "neg"
                          ? "bg-red-100 text-red-600"
                          : item.type === "ques"
                          ? "bg-blue-100 text-blue-600"
                          : "bg-green-100 text-green-600"
                      }">
                          ${item.type === "neg" ? "Verneinung" : item.type === "ques" ? "Frage" : "Aussage"}
                        </div>`
                    : ""
                }
                <p class="whitespace-pre-line text-lg mb-3 font-medium text-slate-700 leading-relaxed pr-8">${item.q}</p>
                <div class="flex gap-2">
                  <input type="text"
                         id="input-${idx}"
                         class="min-w-0 flex-1 bg-slate-50 border border-slate-300 rounded-xl p-3 text-lg outline-none focus:bg-white transition"
                         placeholder="Deine Lösung hier...">
                  <button onclick="checkAnswer(${idx})"
                          class="px-4 py-2 rounded-xl text-sm font-bold bg-slate-800 text-white hover:bg-slate-900 active:scale-95 flex items-center gap-1">
                    <span class="material-symbols-outlined text-base">check</span>
                    Prüfen
                  </button>
                </div>
                <div id="feedback-${idx}" class="mt-2 text-sm"></div>
                <div class="mt-1 text-xs text-slate-500">
                  <span class="font-semibold">Tipp:</span> ${item.hint}
                </div>
              </div>
            `).join("")}
          </div>
        `;
      }

      container.innerHTML = banner + modeSwitcher + contentHTML;
      mainContent.appendChild(container);
      mainContent.scrollTop = 0;
    }

    function switchMode(mode) {
      if (mode === currentMode) return;
      currentMode = mode;
      if (mode === "practice") {
        currentQuestions = [];
      }
      renderContent();
    }

    function reloadQuestions() {
      const data = appData[currentTenseIndex];
      currentQuestions = getRandomQuestionsFromPool(data);
      renderContent();
    }

    function updateFilterButtons() {
      const buttons = document.querySelectorAll(".filter-btn");
      buttons.forEach(btn => {
        const filter = btn.getAttribute("data-filter");
        if (filter === currentPracticeFilter) {
          btn.classList.add("bg-slate-800", "text-white", "border-slate-800");
          btn.classList.remove("bg-white", "text-slate-600");
        } else {
          btn.classList.remove("bg-slate-800", "text-white", "border-slate-800");
          btn.classList.add("bg-white", "text-slate-600", "border-slate-300");
        }
        btn.onclick = () => {
          currentPracticeFilter = filter;
          currentQuestions = [];
          renderContent();
        };
      });
    }

    function normalizeAnswer(str) {
      return str
        .toLowerCase()
        .replace(/[.!?]/g, "")      // Satzzeichen weg
        .replace(/\s+/g, " ")       // Mehrfach-Leerzeichen zu einem
        .trim();
    }

    function canonicalize(str) {
      let s = normalizeAnswer(str);
      const map = {
        "isn't": "is not",
        "aren't": "are not",
        "wasn't": "was not",
        "weren't": "were not",
        "don't": "do not",
        "doesn't": "does not",
        "didn't": "did not",
        "haven't": "have not",
        "hasn't": "has not",
        "hadn't": "had not",
        "won't": "will not",
        "can't": "can not",
        "couldn't": "could not",
        "mustn't": "must not",
        "shouldn't": "should not",
        "mightn't": "might not"
      };
      for (const key in map) {
        const re = new RegExp("\\b" + key + "\\b", "g");
        s = s.replace(re, map[key]);
      }
      return s;
    }

    function checkAnswer(index) {
      const item = currentQuestions[index];
      if (!item) return;

      const input = document.getElementById(`input-${index}`);
      const feedback = document.getElementById(`feedback-${index}`);
      if (!input || !feedback) return;

      const userRaw = input.value;
      const correctRaw = item.a;

      const user = canonicalize(userRaw);
      const correct = canonicalize(correctRaw);

      if (!user) {
        feedback.innerHTML = `<span class="text-amber-600 text-sm flex items-center gap-1">
          <span class="material-symbols-outlined text-base">info</span> Bitte gib erst eine Antwort ein.
        </span>`;
        return;
      }

      if (user === correct) {
        feedback.innerHTML = `<span class="text-emerald-600 text-sm flex items-center gap-1">
          <span class="material-symbols-outlined text-base">check_circle</span> Richtig! (${correctRaw})
        </span>`;
      } else {
        feedback.innerHTML = `
          <div class="text-red-600 text-sm flex items-start gap-1">
            <span class="material-symbols-outlined text-base mt-[2px]">cancel</span>
            <div>
              <div>Leider nicht ganz richtig.</div>
              <div class="text-slate-700"><span class="font-semibold">Lösung:</span> ${correctRaw}</div>
            </div>
          </div>
        `;
      }
    }

    function softReset() {
      currentTenseIndex = 0;
      currentMode = "learn";
      currentQuestions = [];
      currentPracticeFilter = "all";
      renderNav();
      renderContent();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  </script>
</body>
</html>
