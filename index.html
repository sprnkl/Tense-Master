<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Grammar Master - Logic Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { primary: '#2563eb', secondary: '#475569' }
        }
      }
    }
  </script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">
  
  <header class="bg-white shadow-sm z-20 flex-none">
    <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-primary text-3xl">school</span>
        <div>
          <h1 class="text-xl font-bold text-primary tracking-tight">Grammar Master</h1>
          <p class="text-xs text-slate-500">Logische Übungssätze (Hand-coded)</p>
        </div>
      </div>
      <div class="flex items-center gap-3 text-xs">
        <button onclick="softReset()" class="ml-2 text-slate-400 hover:text-primary transition" title="Ansicht zurücksetzen">
          <span class="material-symbols-outlined">refresh</span>
        </button>
      </div>
    </div>
    <div class="relative border-b border-slate-200 bg-white">
      <div class="max-w-5xl mx-auto flex overflow-x-auto no-scrollbar py-2 px-2 gap-2" id="nav-container"></div>
      <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-white to-transparent pointer-events-none md:hidden"></div>
    </div>
  </header>

  <main class="flex-grow overflow-y-auto p-4 relative" id="main-content"></main>

  <div id="floating-action-container" class="fixed bottom-4 left-4 right-4 z-30 hidden">
    <div class="max-w-3xl mx-auto flex flex-col gap-2">
      <div id="tense-filter-bar" class="hidden bg-white border border-slate-200 rounded-2xl shadow-sm px-3 py-2 flex items-center justify-between text-xs">
        <span class="font-semibold text-slate-500 mr-2">Filter:</span>
        <div class="flex gap-1 overflow-x-auto no-scrollbar" id="filter-buttons-container"></div>
      </div>
      
      <button onclick="reloadQuestions()"
              class="w-full bg-slate-800 text-white shadow-xl py-3.5 rounded-2xl font-bold active:scale-95 transition flex items-center justify-center gap-2 backdrop-blur-md bg-opacity-90 border border-slate-700/50">
        <span class="material-symbols-outlined">refresh</span>
        5 neue Sätze laden
      </button>
    </div>
  </div>

  <script>
    // ============================================================
    // DATENBANK: Handverlesene Sätze (Logik statt Zufall)
    // ============================================================
    // Hier kannst du als Lehrer einfach neue Zeilen einfügen.
    // Format: { type: "pos/neg/ques", q: "Satz mit Lücke", a: "Lösung", hint: "Hinweis" }
    
    const sentencePools = {
      "simple-present": [
        { type: "pos", q: "He usually _____ (walk) to school.", a: "walks", hint: "3. Person Singular (he/she/it) + s" },
        { type: "pos", q: "I _____ (play) football every Monday.", a: "play", hint: "I: Grundform" },
        { type: "pos", q: "The sun _____ (rise) in the east.", a: "rises", hint: "Fakt: 3. Person Sg. + s" },
        { type: "pos", q: "We _____ (love) history lessons.", a: "love", hint: "We: Grundform" },
        { type: "pos", q: "She always _____ (forget) her homework.", a: "forgets", hint: "Signalwort 'always' -> Simple Present" },
        { type: "neg", q: "I _____ (not / like) spinach.", a: "don't like", hint: "don't + Grundform" },
        { type: "neg", q: "He _____ (not / speak) French.", a: "doesn't speak", hint: "he -> doesn't" },
        { type: "neg", q: "They _____ (not / live) in Berlin.", a: "don't live", hint: "they -> don't" },
        { type: "neg", q: "The train _____ (not / stop) here.", a: "doesn't stop", hint: "it -> doesn't" },
        { type: "ques", q: "_____ (you / know) the answer?", a: "Do you know", hint: "Do + Subjekt + Verb" },
        { type: "ques", q: "_____ (he / play) the piano?", a: "Does he play", hint: "Does + he + Verb" },
        { type: "ques", q: "Where _____ (they / work)?", a: "do they work", hint: "Fragewort + do + Subjekt" },
        { type: "ques", q: "When _____ (the film / start)?", a: "does the film start", hint: "3. Person Sg. -> does" },
        { type: "pos", q: "My brother _____ (watch) TV every evening.", a: "watches", hint: "Endung -ch -> es" },
        { type: "pos", q: "The earth _____ (move) around the sun.", a: "moves", hint: "Allgemeiner Fakt" },
        { type: "neg", q: "We _____ (not / have) time right now.", a: "don't have", hint: "we -> don't" },
        { type: "ques", q: "Why _____ (you / learn) English?", a: "do you learn", hint: "Why + do + you" }
      ],
      "simple-past": [
        { type: "pos", q: "Columbus _____ (discover) America in 1492.", a: "discovered", hint: "Regelmäßig: +ed" },
        { type: "pos", q: "I _____ (visit) my grandmother yesterday.", a: "visited", hint: "Signalwort 'yesterday'" },
        { type: "pos", q: "We _____ (go) to the cinema last night.", a: "went", hint: "Unregelmäßig: go -> went" },
        { type: "pos", q: "The war _____ (end) in 1945.", a: "ended", hint: "Historisches Datum" },
        { type: "pos", q: "She _____ (buy) a new car last week.", a: "bought", hint: "Unregelmäßig: buy -> bought" },
        { type: "neg", q: "I _____ (not / see) him at the party.", a: "didn't see", hint: "didn't + Grundform" },
        { type: "neg", q: "They _____ (not / enjoy) the movie.", a: "didn't enjoy", hint: "didn't + Grundform" },
        { type: "neg", q: "He _____ (not / come) to school yesterday.", a: "didn't come", hint: "didn't + Grundform" },
        { type: "ques", q: "_____ (you / do) your homework yesterday?", a: "Did you do", hint: "Did + Subjekt + Grundform" },
        { type: "ques", q: "Where _____ (you / be) last summer?", a: "were you", hint: "Achtung: 'be' braucht kein 'did'" },
        { type: "ques", q: "When _____ (Shakespeare / die)?", a: "did Shakespeare die", hint: "Frage im Past: did" },
        { type: "pos", q: "It _____ (rain) a lot last month.", a: "rained", hint: "Regelmäßig: +ed" },
        { type: "pos", q: "They _____ (build) the wall in 1961.", a: "built", hint: "build -> built" },
        { type: "neg", q: "We _____ (not / know) the answer.", a: "didn't know", hint: "didn't + know" },
        { type: "ques", q: "What _____ (he / say)?", a: "did he say", hint: "What + did + he..." }
      ],
      "present-progressive": [
        { type: "pos", q: "Look! He _____ (run) to the bus.", a: "is running", hint: "Signalwort 'Look!'" },
        { type: "pos", q: "I _____ (read) a book at the moment.", a: "am reading", hint: "am + verb-ing" },
        { type: "pos", q: "We _____ (learn) about grammar right now.", a: "are learning", hint: "are + verb-ing" },
        { type: "pos", q: "Listen! The baby _____ (cry).", a: "is crying", hint: "is + verb-ing" },
        { type: "neg", q: "She _____ (not / sleep) now.", a: "isn't sleeping", hint: "is not -> isn't" },
        { type: "neg", q: "They _____ (not / play) football today.", a: "aren't playing", hint: "are not -> aren't" },
        { type: "neg", q: "I _____ (not / listen) to you.", a: "am not listening", hint: "am not + ing" },
        { type: "ques", q: "_____ (you / wait) for someone?", a: "Are you waiting", hint: "Are + you + ing" },
        { type: "ques", q: "What _____ (he / do) right now?", a: "is he doing", hint: "What + is + he..." },
        { type: "ques", q: "_____ (it / rain) outside?", a: "Is it raining", hint: "Is + it + ing" },
        { type: "pos", q: "My computer _____ (update) at the moment.", a: "is updating", hint: "Handlung läuft jetzt" },
        { type: "neg", q: "We _____ (not / watch) TV.", a: "aren't watching", hint: "aren't + ing" }
      ],
      "past-progressive": [
        { type: "pos", q: "I _____ (read) when the phone rang.", a: "was reading", hint: "Lange Handlung in der Vergangenheit" },
        { type: "pos", q: "They _____ (play) cards all evening.", a: "were playing", hint: "they -> were" },
        { type: "pos", q: "It _____ (rain) when we left the house.", a: "was raining", hint: "it -> was" },
        { type: "neg", q: "He _____ (not / listen) to the teacher.", a: "wasn't listening", hint: "was not -> wasn't" },
        { type: "neg", q: "We _____ (not / sleep) at midnight.", a: "weren't sleeping", hint: "were not -> weren't" },
        { type: "ques", q: "What _____ (you / do) at 8 o'clock?", a: "were you doing", hint: "Were + you + ing" },
        { type: "ques", q: "_____ (she / work) yesterday afternoon?", a: "Was she working", hint: "Was + she + ing" },
        { type: "pos", q: "While I _____ (walk) home, I saw a cat.", a: "was walking", hint: "nach 'While' meist Progressive" },
        { type: "neg", q: "The students _____ (not / pay) attention.", a: "weren't paying", hint: "weren't + ing" }
      ],
      "will-future": [
        { type: "pos", q: "I think it _____ (rain) tomorrow.", a: "will rain", hint: "Vermutung: will" },
        { type: "pos", q: "Don't worry, I _____ (help) you.", a: "will help", hint: "Spontanes Versprechen" },
        { type: "pos", q: "In 2100, people _____ (live) on Mars.", a: "will live", hint: "Vorhersage" },
        { type: "neg", q: "I _____ (not / tell) anyone your secret.", a: "won't tell", hint: "won't + Grundform" },
        { type: "neg", q: "He _____ (not / come) to the party.", a: "won't come", hint: "will not -> won't" },
        { type: "ques", q: "_____ (you / marry) me?", a: "Will you marry", hint: "Antrag/Frage" },
        { type: "ques", q: "When _____ (we / arrive)?", a: "will we arrive", hint: "When + will + we" },
        { type: "pos", q: "Maybe I _____ (become) a teacher.", a: "will become", hint: "mit 'Maybe' oft will-future" }
      ],
      "going-to-future": [
        { type: "pos", q: "Look at those clouds! It _____ (rain).", a: "is going to rain", hint: "Klares Anzeichen -> going to" },
        { type: "pos", q: "I _____ (visit) my aunt next weekend.", a: "am going to visit", hint: "Fester Plan" },
        { type: "pos", q: "We _____ (buy) a new house soon.", a: "are going to buy", hint: "Plan" },
        { type: "neg", q: "She _____ (not / play) tennis tomorrow.", a: "isn't going to play", hint: "isn't going to" },
        { type: "neg", q: "I _____ (not / do) that.", a: "am not going to do", hint: "am not going to" },
        { type: "ques", q: "_____ (you / watch) the game tonight?", a: "Are you going to watch", hint: "Are you going to..." },
        { type: "ques", q: "What _____ (he / cook) for dinner?", a: "is he going to cook", hint: "Is he going to..." }
      ],
      "present-perfect": [
        { type: "pos", q: "I _____ (lose) my keys. I can't find them.", a: "have lost", hint: "Ergebnis in der Gegenwart wichtig" },
        { type: "pos", q: "She _____ (visit) Paris three times.", a: "has visited", hint: "Erfahrung (Zeit egal)" },
        { type: "pos", q: "We _____ (just / finish) our homework.", a: "have just finished", hint: "Signalwort 'just'" },
        { type: "neg", q: "I _____ (not / see) this movie yet.", a: "haven't seen", hint: "Signalwort 'yet'" },
        { type: "neg", q: "He _____ (not / arrive) so far.", a: "hasn't arrived", hint: "he -> hasn't" },
        { type: "ques", q: "_____ (you / ever / eat) sushi?", a: "Have you ever eaten", hint: "ever + 3. Form" },
        { type: "ques", q: "Where _____ (they / go)?", a: "have they gone", hint: "Have + they + 3. Form" },
        { type: "pos", q: "The President _____ (sign) the new law.", a: "has signed", hint: "Neuigkeit" },
        { type: "pos", q: "I _____ (know) him for ten years.", a: "have known", hint: "Dauer bis jetzt (for)" }
      ],
      "past-perfect": [
        { type: "pos", q: "When I arrived, the train _____ (already / leave).", a: "had already left", hint: "War schon passiert -> had + 3. Form" },
        { type: "pos", q: "She was tired because she _____ (work) so much.", a: "had worked", hint: "Grund in der Vorvergangenheit" },
        { type: "pos", q: "The thief _____ (escape) before the police came.", a: "had escaped", hint: "had + 3. Form" },
        { type: "neg", q: "I _____ (not / eat) anything all day.", a: "hadn't eaten", hint: "hadn't + 3. Form" },
        { type: "neg", q: "They _____ (not / finish) the project by Monday.", a: "hadn't finished", hint: "hadn't + 3. Form" },
        { type: "ques", q: "_____ (you / see) him before that day?", a: "Had you seen", hint: "Had + Person + 3. Form" },
        { type: "ques", q: "Where _____ (he / live) before moving to London?", a: "had he lived", hint: "Had + he + 3. Form" }
      ],
      "if-clauses": [
        { type: "type1", q: "If it rains, we _____ (stay) at home.", a: "will stay", hint: "Typ 1: Real (Simple Present -> Will-Future)" },
        { type: "type1", q: "If you learn vocabulary, you _____ (pass) the test.", a: "will pass", hint: "Typ 1: Will + Grundform" },
        { type: "type1", q: "I will call you if I _____ (have) time.", a: "have", hint: "Typ 1: If-Satz im Simple Present" },
        { type: "type2", q: "If I _____ (be) a millionaire, I would buy an island.", a: "were", hint: "Typ 2: Unreal (Simple Past -> Would)" },
        { type: "type2", q: "If I had a car, I _____ (drive) to Italy.", a: "would drive", hint: "Typ 2: Would + Grundform" },
        { type: "type2", q: "He would help you if he _____ (know) the answer.", a: "knew", hint: "Typ 2: If-Satz im Simple Past" },
        { type: "type3", q: "If I _____ (learn) more, I would have passed.", a: "had learned", hint: "Typ 3: Vergangenheit (Past Perfect)" },
        { type: "type3", q: "If she hadn't been late, she _____ (see) him.", a: "would have seen", hint: "Typ 3: Would + have + 3. Form" },
        { type: "type3", q: "We would have gone to the beach if it _____ (not / rain).", a: "hadn't rained", hint: "Typ 3: If + Past Perfect" }
      ],
      "comparatives": [
        { type: "mix", q: "An elephant is _____ (big) than a mouse.", a: "bigger", hint: "Silbe kurz -> doppl. Konsonant + er" },
        { type: "mix", q: "This is the _____ (bad) film I have ever seen.", a: "worst", hint: "bad -> worse -> worst" },
        { type: "mix", q: "English is _____ (easy) than Chinese.", a: "easier", hint: "y -> ier" },
        { type: "mix", q: "History is _____ (interesting) than Math.", a: "more interesting", hint: "Lang -> more" },
        { type: "mix", q: "Who is the _____ (fast) runner in the world?", a: "fastest", hint: "Superlativ: -est" },
        { type: "mix", q: "This car is _____ (expensive) than that one.", a: "more expensive", hint: "Lang -> more" },
        { type: "mix", q: "You are my _____ (good) friend.", a: "best", hint: "good -> better -> best" },
        { type: "mix", q: "Summer is _____ (hot) than winter.", a: "hotter", hint: "kurz -> doppel-t + er" }
      ],
      "questions": [
        { type: "ques", q: "_____ (you / like) pizza?", a: "Do you like", hint: "Hilfsverb 'Do' nötig" },
        { type: "ques", q: "Where _____ (he / live)?", a: "does he live", hint: "Fragewort + does + he" },
        { type: "ques", q: "_____ (she / be) tired?", a: "Is she", hint: "Kein 'do' bei 'to be'" },
        { type: "ques", q: "What _____ (you / do) yesterday?", a: "did you do", hint: "Vergangenheit -> did" },
        { type: "ques", q: "Who _____ (invent) the telephone?", a: "invented", hint: "Subjektfrage (wer?) -> kein did!" },
        { type: "ques", q: "How long _____ (you / wait) here?", a: "have you waited", hint: "Present Perfect -> have" },
        { type: "ques", q: "Why _____ (they / not / come) to the party?", a: "didn't they come", hint: "Verneinte Frage im Past" },
        { type: "ques", q: "_____ (you / can / swim)?", a: "Can you swim", hint: "Modalverb vorziehen" }
      ],
      "modals": [
        { type: "mix", q: "You _____ (must) do your homework.", a: "must", hint: "Pflicht" },
        { type: "mix", q: "I _____ (can / not) hear you.", a: "can't", hint: "Fähigkeit verneint" },
        { type: "mix", q: "We _____ (should) help the poor.", a: "should", hint: "Moralische Pflicht / Rat" },
        { type: "mix", q: "You _____ (must / not) smoke in school.", a: "mustn't", hint: "Verbot" },
        { type: "mix", q: "_____ (May) I open the window?", a: "May", hint: "Höfliche Frage" },
        { type: "mix", q: "He _____ (have to) get up early yesterday.", a: "had to", hint: "Vergangenheit von must -> had to" },
        { type: "mix", q: "She _____ (might) be late today.", a: "might", hint: "Möglichkeit" }
      ],
      "much-many": [
        { type: "mix", q: "How _____ (much/many) money do you have?", a: "much", hint: "Geld ist unzählbar" },
        { type: "mix", q: "There are _____ (much/many) students in the class.", a: "many", hint: "Schüler sind zählbar" },
        { type: "mix", q: "I don't have _____ (much/many) time.", a: "much", hint: "Zeit ist unzählbar" },
        { type: "mix", q: "How _____ (much/many) books did you read?", a: "many", hint: "Bücher sind zählbar" },
        { type: "mix", q: "There isn't _____ (much/many) water left.", a: "much", hint: "Wasser ist unzählbar" },
        { type: "mix", q: "Too _____ (much/many) cooks spoil the broth.", a: "many", hint: "Sprichwort: Köche" }
      ],
      "word-order": [
        { type: "mix", q: "Ordne: (always / I / breakfast / eat / at 7)", a: "I always eat breakfast at 7.", hint: "Subjekt - Häufigkeit - Verb" },
        { type: "mix", q: "Ordne: (yesterday / football / played / we)", a: "We played football yesterday.", hint: "Zeit ans Ende" },
        { type: "mix", q: "Ordne: (never / she / to London / been / has)", a: "She has never been to London.", hint: "never zwischen Hilfsverb und Verb" },
        { type: "mix", q: "Ordne: (homework / doing / is / now / he)", a: "He is doing homework now.", hint: "S-P-O" },
        { type: "mix", q: "Ordne: (the book / gave / I / him)", a: "I gave him the book.", hint: "Wem? (him) vor Was? (book)" }
      ],
      "reported-speech": [
        { type: "mix", q: "'I am happy.' -> He said that he _____ happy.", a: "was", hint: "am -> was" },
        { type: "mix", q: "'I will help you.' -> She said she _____ help me.", a: "would", hint: "will -> would" },
        { type: "mix", q: "'I can swim.' -> He said he _____ swim.", a: "could", hint: "can -> could" },
        { type: "mix", q: "'I visited London.' -> She said she _____ London.", a: "had visited", hint: "Simple Past -> Past Perfect" },
        { type: "mix", q: "'I have done it.' -> He said he _____ it.", a: "had done", hint: "Present Perfect -> Past Perfect" },
        { type: "mix", q: "'Do you like tea?' -> He asked if I _____ tea.", a: "liked", hint: "Simple Present -> Simple Past" }
      ]
    };

    // ============================================================
    // APP LOGIC
    // ============================================================

    const appData = [
      { id: "simple-present", name: "Simple Present", isTense: true, color: "from-blue-600 to-cyan-500", learn: {
          intro: "Fakten, Gewohnheiten & regelmäßige Handlungen.",
          bullets: ["Signalwörter: always, never, often, usually, every day", "3. Person Singular: +s (He/She/It das 's' muss mit!)"],
          positive: { title: "Aussage", rule: "Subjekt + Verb (+s)", explanation: "I play, He plays.", examples: ["He plays football.", "We learn English."] },
          negative: { title: "Verneinung", rule: "don't / doesn't + Grundform", explanation: "I don't play, He doesn't play.", examples: ["She doesn't like spiders."] },
          question: { title: "Frage", rule: "Do / Does + Subjekt + Grundform?", explanation: "Vergisst du das 's' bei does, ist der Satz falsch!", examples: ["Does he live here?"] }
      }},
      { id: "simple-past", name: "Simple Past", isTense: true, color: "from-emerald-600 to-teal-500", learn: {
          intro: "Abgeschlossene Vergangenheit. Historische Fakten.",
          bullets: ["Signalwörter: yesterday, last week, in 1990, ago", "Einmalige oder aufeinanderfolgende Handlungen."],
          positive: { title: "Aussage", rule: "Verb + ed (oder 2. Spalte)", explanation: "Regelmäßig: played. Unregelmäßig: went, saw, bought.", examples: ["I watched TV.", "He went to Rome."] },
          negative: { title: "Verneinung", rule: "didn't + Grundform", explanation: "Achtung: Nach didn't steht immer der Infinitiv!", examples: ["I didn't go. (NICHT went)"] },
          question: { title: "Frage", rule: "Did + Subjekt + Grundform?", explanation: "Auch hier: Grundform nach Did.", examples: ["Did you see him?"] }
      }},
      { id: "present-progressive", name: "Present Progressive", isTense: true, color: "from-indigo-600 to-purple-500", learn: {
          intro: "Handlungen, die JETZT gerade passieren.",
          bullets: ["Signalwörter: now, at the moment, Look!, Listen!", "Ablauf steht im Vordergrund."],
          positive: { title: "Aussage", rule: "am/is/are + verb-ing", explanation: "Form von 'to be' + Ing-Form.", examples: ["I am reading.", "She is sleeping."] },
          negative: { title: "Verneinung", rule: "am not / isn't / aren't + ing", explanation: "Einfach das 'be' verneinen.", examples: ["He isn't listening."] },
          question: { title: "Frage", rule: "Am/Is/Are + Subjekt + ing?", explanation: "'to be' steht vorne.", examples: ["Are you coming?"] }
      }},
      { id: "past-progressive", name: "Past Progressive", isTense: true, color: "from-green-600 to-lime-600", learn: {
          intro: "Lange Handlung in der Vergangenheit.",
          bullets: ["Oft Hintergrundhandlung (war gerade dabei...)", "Unterbrochen durch Simple Past (when...)"],
          positive: { title: "Aussage", rule: "was / were + verb-ing", explanation: "I/he/she/it -> was. You/we/they -> were.", examples: ["I was reading when he called."] },
          negative: { title: "Verneinung", rule: "wasn't / weren't + ing", explanation: "Verneinung von be im Past.", examples: ["They weren't looking."] },
          question: { title: "Frage", rule: "Was/Were + Subjekt + ing?", explanation: "Was he working?", examples: ["What were you doing?"] }
      }},
      { id: "will-future", name: "Will Future", isTense: true, color: "from-violet-600 to-fuchsia-600", learn: {
          intro: "Vorhersagen, Vermutungen & Spontanes.",
          bullets: ["Signalwörter: I think, maybe, probably", "Spontane Entschlüsse ('Wait, I'll help you')"],
          positive: { title: "Aussage", rule: "will + Grundform", explanation: "Für alle Personen gleich.", examples: ["It will rain tomorrow."] },
          negative: { title: "Verneinung", rule: "won't + Grundform", explanation: "won't = will not.", examples: ["I won't tell anyone."] },
          question: { title: "Frage", rule: "Will + Subjekt + Grundform?", explanation: "Will he come?", examples: ["Will we survive?"] }
      }},
      { id: "going-to-future", name: "Going-to Future", isTense: true, color: "from-pink-600 to-rose-500", learn: {
          intro: "Feste Pläne & logische Konsequenzen.",
          bullets: ["Man hat es schon beschlossen.", "Man sieht, dass gleich etwas passiert (Wolken)."],
          positive: { title: "Aussage", rule: "am/is/are + going to + Grundform", explanation: "Nicht das 'to be' vergessen!", examples: ["I am going to buy a car."] },
          negative: { title: "Verneinung", rule: "isn't / aren't + going to...", explanation: "Verneinung von 'be'.", examples: ["He isn't going to fly."] },
          question: { title: "Frage", rule: "Am/Is/Are + S + going to...?", explanation: "Are you going to cook?", examples: ["What are you going to do?"] }
      }},
      { id: "present-perfect", name: "Present Perfect", isTense: true, color: "from-orange-500 to-amber-500", learn: {
          intro: "Vergangenheit mit Auswirkung auf Gegenwart.",
          bullets: ["Zeitpunkt ist UNWICHTIG (anders als Simple Past)", "Signalwörter: just, yet, ever, never, since, for"],
          positive: { title: "Aussage", rule: "have / has + 3. Form", explanation: "He/She/It -> has (das 's' muss mit).", examples: ["I have eaten.", "She has left."] },
          negative: { title: "Verneinung", rule: "haven't / hasn't + 3. Form", explanation: "Kurzform meist verwendet.", examples: ["I haven't finished yet."] },
          question: { title: "Frage", rule: "Have / Has + Subjekt + 3. Form?", explanation: "Have you seen it?", examples: ["Has he arrived?"] }
      }},
      { id: "past-perfect", name: "Past Perfect", isTense: true, color: "from-red-600 to-orange-600", learn: {
          intro: "Die Vor-Vergangenheit.",
          bullets: ["Etwas passierte VOR etwas anderem in der Vergangenheit.", "Plusquamperfekt im Deutschen."],
          positive: { title: "Aussage", rule: "had + 3. Form", explanation: "Für alle Personen 'had'.", examples: ["She had already left when I came."] },
          negative: { title: "Verneinung", rule: "hadn't + 3. Form", explanation: "Verneinung von had.", examples: ["I hadn't seen him before."] },
          question: { title: "Frage", rule: "Had + Subjekt + 3. Form?", explanation: "Had they finished?", examples: ["Had you met him?"] }
      }},
      { id: "if-clauses", name: "If-Clauses", isTense: false, color: "from-sky-600 to-emerald-500", learn: {
          intro: "Bedingungssätze Typ 1, 2 und 3.",
          bullets: ["Typ 1: Real (Präsens -> Future)", "Typ 2: Unreal (Past -> Would)", "Typ 3: Unmöglich (Past Perf -> Would have)"],
          positive: { title: "Typ 1", rule: "If + Simple Pres., will + Verb", explanation: "Erfüllbar. 'If it rains, I will stay.'", examples: ["If I study, I will pass."] },
          negative: { title: "Typ 2", rule: "If + Simple Past, would + Verb", explanation: "Träumerei. 'If I had money, I would buy...'", examples: ["If I were you, I would go."] },
          question: { title: "Typ 3", rule: "If + Past Perf., would have + 3.F", explanation: "Zu spät. 'If I had known, I would have...'", examples: ["If he had asked, I would have helped."] }
      }},
      { id: "comparatives", name: "Comparatives", isTense: false, color: "from-yellow-500 to-orange-500", learn: {
          intro: "Steigerung von Adjektiven.",
          bullets: ["Komparativ (Vergleich), Superlativ (Das Höchste)", "Kurze vs. Lange Adjektive"],
          positive: { title: "Kurz (1 Silbe)", rule: "-er / the -est", explanation: "old -> older -> oldest. (Doppelung: big -> bigger)", examples: ["Tom is taller than Tim."] },
          negative: { title: "Lang (2+ Silben)", rule: "more ... / the most ...", explanation: "modern -> more modern. (Ausnahme: happy -> happier)", examples: ["This is more expensive."] },
          question: { title: "Ausnahmen", rule: "good/bad", explanation: "good->better->best. bad->worse->worst.", examples: ["You are the best."] }
      }},
      { id: "questions", name: "Fragebildung", isTense: false, color: "from-cyan-600 to-blue-500", learn: {
          intro: "Wie man Fragen richtig baut.",
          bullets: ["Hilfsverb (Do, Did, Have, Will) ist meist nötig.", "Wortstellung: (Fragewort) - Hilfsverb - Subjekt - Verb"],
          positive: { title: "Ja/Nein Fragen", rule: "Aux - Subj - Verb?", explanation: "Do you like chips? Have you eaten?", examples: ["Did he call?"] },
          negative: { title: "Fragewörter", rule: "Wh - Aux - Subj - Verb?", explanation: "Where do you live? Why is he crying?", examples: ["What did you say?"] },
          question: { title: "Subjektfrage", rule: "Who/What + Verb?", explanation: "Wenn nach dem Subjekt gefragt wird, fällt 'do' weg.", examples: ["Who called you? (NICHT Who did call)"] }
      }},
      { id: "modals", name: "Modals", isTense: false, color: "from-slate-700 to-slate-500", learn: {
          intro: "Können, müssen, sollen, dürfen.",
          bullets: ["Kein 's' in der 3. Person!", "Kein 'don't/doesn't' zur Verneinung."],
          positive: { title: "Basis", rule: "can, must, should, may", explanation: "gefolgt von der Grundform.", examples: ["He can swim.", "You must go."] },
          negative: { title: "Ersatzformen", rule: "have to, be able to", explanation: "Nötig für andere Zeitformen.", examples: ["I had to work yesterday."] },
          question: { title: "Verneinung", rule: "can't, mustn't, shouldn't", explanation: "mustn't = nicht dürfen (Verbot)!", examples: ["You mustn't smoke."] }
      }},
      { id: "much-many", name: "Much / Many", isTense: false, color: "from-lime-500 to-emerald-500", learn: {
          intro: "Mengensanagaben unterscheiden.",
          bullets: ["Zählbar (Apples, Cars) -> MANY", "Unzählbar (Water, Money, Time) -> MUCH"],
          positive: { title: "Many", rule: "Many + Plural", explanation: "Alles, was man zählen kann.", examples: ["How many friends?"] },
          negative: { title: "Much", rule: "Much + Singular", explanation: "Stoffe, Flüssigkeiten, Abstraktes.", examples: ["How much time?"] },
          question: { title: "A lot of", rule: "Passt immer", explanation: "In Aussagesätzen oft sicherer.", examples: ["I have a lot of time/friends."] }
      }},
      { id: "word-order", name: "Satzbau", isTense: false, color: "from-amber-600 to-red-500", learn: {
          intro: "S-P-O (Subjekt - Prädikat - Objekt).",
          bullets: ["Ort vor Zeit!", "Häufigkeitsadverbien vor das Hauptverb."],
          positive: { title: "Grundregel", rule: "Wer tut was wo wann?", explanation: "I played football in the park yesterday.", examples: ["Nicht Zeit in die Mitte stellen!"] },
          negative: { title: "Adverbien", rule: "always, never, often", explanation: "Vor Vollverb (I often eat), aber nach 'to be' (I am often late).", examples: ["He never listens."] },
          question: { title: "Ort vor Zeit", rule: "Place before Time", explanation: "I go to school at 8. (NICHT I go at 8 to school)", examples: ["In London in 2020."] }
      }},
      { id: "reported-speech", name: "Reported Speech", isTense: false, color: "from-slate-600 to-indigo-600", learn: {
          intro: "Indirekte Rede (Backshift).",
          bullets: ["Wenn das Einleitungsverb (said/told) Past ist, rutscht die Zeit zurück.", "Present -> Past, Past -> Past Perf."],
          positive: { title: "Zeitwechsel", rule: "is->was, go->went, will->would", explanation: "Man geht einen Schritt zurück.", examples: ["'I am ill' -> He said he was ill."] },
          negative: { title: "Pronomen", rule: "I -> he/she", explanation: "Logisch anpassen.", examples: ["'My car' -> his car."] },
          question: { title: "Fragen", rule: "if + gerader Satz", explanation: "Keine Frageform mehr! if I was... (NICHT if was I)", examples: ["He asked if I liked it."] }
      }}
    ];

    let currentTenseIndex = 0;
    let currentMode = "learn";
    let currentQuestions = [];
    let currentPracticeFilter = "all";

    const navContainer = document.getElementById("nav-container");
    const mainContent  = document.getElementById("main-content");
    const floatingContainer = document.getElementById("floating-action-container");
    const filterBar = document.getElementById("tense-filter-bar");
    const filterButtonsContainer = document.getElementById("filter-buttons-container");

    // Funktion zum Mischen und Auswählen von Fragen
    function getRandomQuestionsFromPool(topicId) {
      let pool = sentencePools[topicId] || [];
      
      // Filterlogik
      if (currentPracticeFilter !== "all") {
        pool = pool.filter(item => item.type === currentPracticeFilter);
        // Fallback, falls Filter leer ist (z.B. keine Fragen im Pool)
        if (pool.length === 0) pool = sentencePools[topicId]; 
      }

      // Mischen (Fisher-Yates Shuffle)
      const shuffled = [...pool];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      
      // Nimm die ersten 5
      return shuffled.slice(0, 5);
    }

    function init() {
      renderNav();
      renderContent();
    }

    window.onload = init;

    function renderNav() {
      navContainer.innerHTML = "";
      appData.forEach((topic, index) => {
        const isActive = index === currentTenseIndex;
        const btn = document.createElement("button");
        btn.className =
          "px-4 py-2.5 rounded-full text-xs md:text-sm font-bold transition-all whitespace-nowrap flex-shrink-0 border-2 " +
          (isActive
            ? `bg-gradient-to-r ${topic.color} text-white border-transparent shadow-lg transform scale-105`
            : "bg-white text-slate-500 border-slate-200 hover:border-slate-300 hover:bg-slate-50");
        btn.textContent = topic.name;
        btn.onclick = () => {
          currentTenseIndex = index;
          currentMode = "learn";
          currentQuestions = [];
          currentPracticeFilter = "all";
          renderNav();
          renderContent();
        };
        navContainer.appendChild(btn);
      });
    }

    function updateFilterBarUI() {
      const data = appData[currentTenseIndex];
      filterButtonsContainer.innerHTML = "";

      let filters = [];
      if (data.isTense) {
        filters = [
          { label: "Alle", val: "all" },
          { label: "Aussagen", val: "pos" },
          { label: "Verneinungen", val: "neg" },
          { label: "Fragen", val: "ques" }
        ];
      } else if (data.id === 'if-clauses') {
        filters = [
          { label: "Alle", val: "all" },
          { label: "Typ 1", val: "type1" },
          { label: "Typ 2", val: "type2" },
          { label: "Typ 3", val: "type3" }
        ];
      } else {
        filterBar.classList.add("hidden");
        return;
      }

      filterBar.classList.remove("hidden");
      filters.forEach(f => {
        const btn = document.createElement("button");
        const isActive = currentPracticeFilter === f.val;
        btn.className = `px-3 py-1 rounded-full border text-[11px] font-semibold whitespace-nowrap transition-colors ${
          isActive 
            ? "bg-slate-800 text-white border-slate-800" 
            : "bg-white text-slate-600 border-slate-300 hover:bg-slate-50"
        }`;
        btn.textContent = f.label;
        btn.onclick = () => {
          currentPracticeFilter = f.val;
          currentQuestions = [];
          renderContent();
        };
        filterButtonsContainer.appendChild(btn);
      });
    }

    function renderContent() {
      const data = appData[currentTenseIndex];
      mainContent.innerHTML = "";
      
      const container = document.createElement("div");
      container.className = "max-w-4xl mx-auto fade-in pb-32";

      const banner = `
        <div class="rounded-2xl bg-gradient-to-r ${data.color} p-6 text-white shadow-lg mb-6 relative overflow-hidden">
          <div class="relative z-10">
            <h2 class="text-3xl font-extrabold tracking-tight mb-2">${data.name}</h2>
            <p class="opacity-90 font-medium mb-2">${data.learn.intro}</p>
            <ul class="text-sm opacity-90 list-disc ml-4 space-y-1">
              ${data.learn.bullets.map(b => `<li>${b}</li>`).join("")}
            </ul>
          </div>
          <span class="material-symbols-outlined absolute -right-4 -bottom-6 text-9xl opacity-20 rotate-12">menu_book</span>
        </div>
      `;

      const modeSwitcher = `
        <div class="bg-white p-1.5 rounded-xl shadow-sm border border-slate-200 mb-6 flex">
          <button onclick="switchMode('learn')"
                  class="flex-1 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${currentMode === "learn" ? "bg-slate-100 text-slate-800 shadow-inner" : "text-slate-500 hover:text-slate-700"}">
            <span class="material-symbols-outlined">menu_book</span> Erklären
          </button>
          <button onclick="switchMode('practice')"
                  class="flex-1 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${currentMode === "practice" ? "bg-slate-100 text-slate-800 shadow-inner" : "text-slate-500 hover:text-slate-700"}">
            <span class="material-symbols-outlined">edit_note</span> Üben
          </button>
        </div>
      `;

      let contentHTML = "";

      if (currentMode === "learn") {
        floatingContainer.classList.add("hidden");
        filterBar.classList.add("hidden"); 

        const createCard = (block, icon, colorClass, textClass) => `
          <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
            <div class="${colorClass} px-4 py-3 flex items-center gap-2 border-b border-slate-100">
              <span class="material-symbols-outlined text-white">${icon}</span>
              <span class="font-bold text-white uppercase text-sm tracking-wider">${block.title}</span>
            </div>
            <div class="p-5 space-y-3">
              <p class="font-mono text-base md:text-lg font-medium ${textClass} bg-slate-50 p-3 rounded-lg border border-slate-100">
                ${block.rule}
              </p>
              <p class="text-sm text-slate-700 leading-relaxed">${block.explanation}</p>
              <div class="space-y-1">
                ${block.examples.map(ex => `
                  <div class="text-slate-700 text-sm flex gap-2">
                    <span class="text-slate-400">•</span> ${ex}
                  </div>`).join("")}
              </div>
            </div>
          </div>
        `;

        contentHTML = `
          <div class="space-y-6">
            ${createCard(data.learn.positive, "add_circle", "bg-green-500", "text-green-700")}
            ${createCard(data.learn.negative, "cancel", "bg-red-500", "text-red-700")}
            ${createCard(data.learn.question, "help", "bg-blue-500", "text-blue-700")}
          </div>
        `;
      } else {
        floatingContainer.classList.remove("hidden");
        updateFilterBarUI();

        if (currentQuestions.length === 0) {
          currentQuestions = getRandomQuestionsFromPool(data.id);
        }

        const totalInPool = sentencePools[data.id] ? sentencePools[data.id].length : 0;

        contentHTML = `
          <div class="space-y-4">
            <div class="flex justify-between items-center text-xs text-slate-400 font-medium">
              <span>Pool: ${totalInPool} Sätze</span>
              ${(data.isTense || data.id === 'if-clauses') && currentPracticeFilter !== "all"
                ? `<span class="bg-slate-100 px-2 py-1 rounded">Filter: ${currentPracticeFilter.toUpperCase()}</span>`
                : ""}
            </div>
            ${currentQuestions.map((item, idx) => `
              <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 transition-all focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 relative overflow-hidden">
                ${(data.isTense || data.id === 'if-clauses') ? 
                  `<div class="absolute top-0 right-0 px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-bl-xl 
                    ${item.type.includes('neg') || item.type === 'type2' ? 'bg-red-100 text-red-600' : 
                      item.type.includes('ques') || item.type === 'type3' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'}">
                    ${item.type === 'pos' ? 'Aussage' : item.type === 'neg' ? 'Verneinung' : item.type === 'ques' ? 'Frage' : item.type}
                   </div>` : ''}
                
                <p class="whitespace-pre-line text-lg mb-3 font-medium text-slate-700 leading-relaxed pr-8">${item.q}</p>
                <div class="flex gap-2">
                  <input type="text" 
                         id="input-${idx}" 
                         class="min-w-0 flex-1 bg-slate-50 border border-slate-300 rounded-xl p-3 text-lg outline-none focus:bg-white transition"
                         placeholder="Lösung..." 
                         onkeydown="if(event.key === 'Enter') checkAnswer(${idx})">
                  <button onclick="checkAnswer(${idx})" 
                          class="px-4 py-2 rounded-xl text-sm font-bold bg-slate-800 text-white hover:bg-slate-900 active:scale-95 flex items-center gap-1">
                    <span class="material-symbols-outlined text-base">check</span>
                  </button>
                </div>
                <div id="feedback-${idx}" class="mt-2 text-sm min-h-[24px]"></div>
                <div class="mt-1 text-xs text-slate-500 flex items-center gap-1">
                  <span class="material-symbols-outlined text-[14px]">lightbulb</span> ${item.hint}
                </div>
              </div>
            `).join("")}
          </div>
        `;
      }

      container.innerHTML = banner + modeSwitcher + contentHTML;
      mainContent.appendChild(container);
      mainContent.scrollTop = 0;
    }

    function switchMode(mode) {
      if (mode === currentMode) return;
      currentMode = mode;
      if (mode === "practice") {
        currentQuestions = [];
      }
      renderContent();
    }

    function reloadQuestions() {
      const data = appData[currentTenseIndex];
      currentQuestions = getRandomQuestionsFromPool(data.id);
      renderContent();
    }

    function normalizeAnswer(str) {
      return str
        .toLowerCase()
        .replace(/[.!?]/g, "")       
        .replace(/\s+/g, " ")        
        .trim();
    }

    // Erweiterte Normalisierung für Apostrophe und Kurzformen
    function canonicalize(str) {
      let s = normalizeAnswer(str);
      // Apostroph-Variationen ersetzen
      s = s.replace(/’/g, "'").replace(/´/g, "'");
      
      const map = {
        "isn't": "is not", "aren't": "are not", "wasn't": "was not", "weren't": "were not",
        "don't": "do not", "doesn't": "does not", "didn't": "did not",
        "haven't": "have not", "hasn't": "has not", "hadn't": "had not",
        "won't": "will not", "can't": "can not", "mustn't": "must not",
        "shouldn't": "should not", "mightn't": "might not",
        "i'm": "i am", "you're": "you are", "we're": "we are", "they're": "they are",
        "he's": "he is", "she's": "she is", "it's": "it is"
      };
      
      // Nur ganze Wörter ersetzen
      for (const key in map) {
        // Wortgrenzen beachten, damit "can" nicht in "can't" ersetzt wird
        if (s.includes(key)) {
           s = s.split(key).join(map[key]);
        }
      }
      return s;
    }

    function checkAnswer(index) {
      const item = currentQuestions[index];
      if (!item) return;

      const input = document.getElementById(`input-${index}`);
      const feedback = document.getElementById(`feedback-${index}`);
      if (!input || !feedback) return;

      const userRaw = input.value;
      if (!userRaw.trim()) {
        feedback.innerHTML = `<span class="text-amber-600 font-medium">Bitte etwas eingeben.</span>`;
        return;
      }

      const correctRaw = item.a;
      const user = canonicalize(userRaw);
      const correct = canonicalize(correctRaw);

      // Sonderfall: Erlaubt Kurzform UND Langform als richtig, da canonicalize beide angleicht
      if (user === correct) {
        feedback.innerHTML = `<span class="text-emerald-600 font-bold flex items-center gap-1"><span class="material-symbols-outlined text-lg">check_circle</span> Richtig!</span>`;
        input.classList.add("border-emerald-500", "bg-emerald-50", "text-emerald-700");
      } else {
        feedback.innerHTML = `
          <div class="text-red-600 flex items-start gap-1">
            <span class="material-symbols-outlined text-lg mt-0.5">cancel</span>
            <div>
              <div class="font-bold">Leider falsch.</div>
              <div class="text-slate-800 text-sm mt-1">Lösung: <span class="font-bold font-mono text-primary">${correctRaw}</span></div>
            </div>
          </div>
        `;
        input.classList.add("border-red-300", "bg-red-50");
      }
    }

    function softReset() {
      currentTenseIndex = 0;
      currentMode = "learn";
      currentQuestions = [];
      currentPracticeFilter = "all";
      renderNav();
      renderContent();
    }
  </script>
</body>
</html>
